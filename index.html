<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantasy RPG Adventure</title>
    <style>
        :root {
            --color-bg-base: #0f172a;
            --color-bg-elevated: #1e293b;
            --color-bg-surface: #334155;
            --color-text-primary: #f1f5f9;
            --color-text-secondary: #cbd5e1;
            --color-text-muted: #94a3b8;
            --color-primary: #38bdf8;
            --color-primary-hover: #0ea5e9;
            --color-success: #22c55e;
            --color-warning: #f59e0b;
            --color-danger: #ef4444;
            --color-border: rgba(203, 213, 225, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: var(--color-text-primary);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .game-container {
            max-width: 900px;
            width: 100%;
            background: var(--color-bg-elevated);
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .town-screen, .dungeon-screen, .battle-screen {
            padding: 30px;
        }

        .header {
            background: var(--color-bg-surface);
            padding: 20px 30px;
            border-bottom: 2px solid var(--color-border);
        }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .stat {
            background: var(--color-bg-base);
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid var(--color-border);
        }

        .stat-label {
            font-size: 11px;
            color: var(--color-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-primary);
        }

        .progress-bar {
            background: var(--color-bg-base);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            height: 100%;
            background: var(--color-success);
            transition: width 0.3s ease;
        }

        .progress-fill.exp {
            background: var(--color-primary);
        }

        .progress-fill.sp {
            background: #6366f1;
        }

        .rarity-common { color: #94a3b8; }
        .rarity-uncommon { color: #22c55e; }
        .rarity-rare { color: #3b82f6; }
        .rarity-epic { color: #a855f7; }
        .rarity-legendary { color: #f59e0b; }
        .rarity-unique { color: #ef4444; font-weight: 700; }

        .affix-positive { color: #22c55e; font-size: 13px; }
        .affix-negative { color: #ef4444; font-size: 13px; }

        .gacha-screen {
            padding: 30px;
            text-align: center;
        }

        .gacha-button {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 20px 40px;
            font-size: 20px;
            font-weight: 700;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(245, 158, 11, 0.4);
            transition: all 0.3s ease;
        }

        .gacha-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(245, 158, 11, 0.6);
        }

        .area-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 999px;
            background: var(--color-bg-base);
            color: var(--color-text-secondary);
            font-size: 12px;
            margin-left: 8px;
        }

        h1 {
            font-size: 28px;
            margin-bottom: 20px;
            color: var(--color-primary);
        }

        h2 {
            font-size: 22px;
            margin-bottom: 15px;
            color: var(--color-text-primary);
        }

        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin: 20px 0;
        }

        button {
            background: var(--color-bg-surface);
            color: var(--color-text-primary);
            border: 1px solid var(--color-border);
            padding: 15px 20px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        button:hover {
            background: var(--color-primary);
            border-color: var(--color-primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(56, 189, 248, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .enemy-info {
            background: var(--color-bg-surface);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid var(--color-danger);
        }

        .enemy-name {
            font-size: 24px;
            color: var(--color-danger);
            margin-bottom: 10px;
        }

        .battle-log {
            background: var(--color-bg-base);
            padding: 15px;
            border-radius: 8px;
            height: 150px;
            overflow-y: auto;
            margin: 20px 0;
            border: 1px solid var(--color-border);
        }

        .log-entry {
            padding: 5px 0;
            color: var(--color-text-secondary);
            font-size: 14px;
        }

        .log-entry.damage {
            color: var(--color-danger);
        }

        .log-entry.heal {
            color: var(--color-success);
        }

        .log-entry.level-up {
            color: var(--color-warning);
            font-weight: 600;
        }

        .inventory-item {
            background: var(--color-bg-surface);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid var(--color-border);
        }

        .skills-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        .skill-card {
            background: var(--color-bg-surface);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--color-border);
            text-align: center;
        }

        .skill-name {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--color-primary);
        }

        .skill-level {
            font-size: 12px;
            color: var(--color-text-muted);
        }

        .skill-points {
            background: var(--color-warning);
            color: var(--color-bg-base);
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            display: inline-block;
            margin: 15px 0;
        }

        .dungeon-info {
            background: var(--color-bg-surface);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .victory-message {
            background: linear-gradient(135deg, var(--color-success) 0%, #16a34a 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 18px;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .button-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="header">
            <div class="stats-bar">
                <div class="stat">
                    <div class="stat-label">ãƒ¬ãƒ™ãƒ«</div>
                    <div class="stat-value" id="level">1</div>
                </div>
                <div class="stat">
                    <div class="stat-label">HP</div>
                    <div class="stat-value" id="hp">100/100</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="hp-bar" style="width: 100%"></div>
                    </div>
                </div>
                <div class="stat">
                    <div class="stat-label">SP</div>
                    <div class="stat-value" id="sp">30/30</div>
                    <div class="progress-bar">
                        <div class="progress-fill sp" id="sp-bar" style="width: 100%"></div>
                    </div>
                </div>
                <div class="stat">
                    <div class="stat-label">çµŒé¨“å€¤</div>
                    <div class="stat-value" id="exp">0/100</div>
                    <div class="progress-bar">
                        <div class="progress-fill exp" id="exp-bar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="stat">
                    <div class="stat-label">ã‚´ãƒ¼ãƒ«ãƒ‰</div>
                    <div class="stat-value" id="gold">5000</div>
                </div>
                <div class="stat">
                    <div class="stat-label">ç¾åœ¨ã‚¨ãƒªã‚¢</div>
                    <div class="stat-value" id="current-area-label">ã¯ã˜ã¾ã‚Šã®æ£®</div>
                </div>
            </div>
        </div>

        <div id="town" class="screen active town-screen">
            <h1>ğŸ° ç”ºã®åºƒå ´</h1>
            <p style="color: var(--color-text-secondary); margin-bottom: 10px;">
                å†’é™ºè€…ã‚ˆã€ã‚ˆã†ã“ãã€‚ã“ã“ã‹ã‚‰å›ã®å†’é™ºãŒå§‹ã¾ã‚‹ã€‚
            </p>
            <p style="color: var(--color-text-muted); margin-bottom: 20px; font-size: 14px;">
                ã‚¨ãƒªã‚¢ã‚’é¸ã³ã€è£…å‚™ã‚’æ•´ãˆã¦å†’é™ºã«å‡ºã‚ˆã†ã€‚é‹è©¦ã—ã«ã‚¬ãƒãƒ£ã‚‚å›ã›ã‚‹ãï¼
            </p>

            <h2>ğŸŒ å†’é™ºã‚¨ãƒªã‚¢é¸æŠ</h2>
            <div class="button-grid">
                <button onclick="game.selectArea(1)">ğŸŒ² ã¯ã˜ã¾ã‚Šã®æ£®<span class="area-badge">ã‚¨ãƒªã‚¢1</span></button>
                <button onclick="game.selectArea(2)" id="area2-btn">ğŸ›£ï¸ ç”ºã¸ã¨ç¶šãé“<span class="area-badge">ã‚¨ãƒªã‚¢2</span></button>
                <button onclick="game.selectArea(3)" id="area3-btn">ğŸš è¡—ã¯ãšã‚Œã®ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³<span class="area-badge">ã‚¨ãƒªã‚¢3</span></button>
                <button onclick="game.selectArea(4)" id="area4-btn">ğŸŒ‘ æš—é»’ã®æ£®<span class="area-badge">ã‚¨ãƒªã‚¢4</span></button>
            </div>

            <h2>ğŸ™ ç”ºã®æ–½è¨­</h2>                <div class="button-grid">
                <button onclick="game.enterDungeon()">âš”ï¸ é¸æŠã‚¨ãƒªã‚¢ã¸å‡ºç™º</button>
                <button onclick="game.showSkills()">ğŸ“Š ã‚¹ã‚­ãƒ«ç”»é¢</button>
                <button onclick="game.showInventory()">ğŸ’ è£…å‚™ãƒ»ã‚¢ã‚¤ãƒ†ãƒ  (<span id="inventory-count">0</span>/<span id="inventory-max">20</span>)</button>
                <button onclick="game.showStorage()">ğŸ“¦ å€‰åº« (<span id="storage-count">0</span>/<span id="storage-max">10</span>)</button>
                <button onclick="game.rest()">ğŸ›Œ å®¿å±‹ã§ä¼‘ã‚€ (30G)</button>
                <button onclick="game.openShop()">ğŸª é“å…·å±‹ï¼ˆè³¼å…¥ãƒ»å£²å´ï¼‰</button>
                <button onclick="game.openGacha()">ğŸ° ã‚¬ãƒãƒ£ (250G)</button>
            </div>
        </div>

        <div id="dungeon" class="screen dungeon-screen">
            <h1>ğŸŒ‘ å†’é™ºã‚¨ãƒªã‚¢</h1>
            <div class="dungeon-info">
                <p id="dungeon-area-text" style="color: var(--color-text-secondary); margin-bottom: 8px;">
                    ã¯ã˜ã¾ã‚Šã®æ£®ã€‚é™ã‹ãªæ£®ã ãŒã€é­”ç‰©ã®æ°—é…ãŒã™ã‚‹â€¦
                </p>
                <p style="color: var(--color-warning); margin-top: 4px; font-weight: 600;">
                    ãƒ©ã‚¦ãƒ³ãƒ‰: <span id="dungeon-depth">0/20</span>
                </p>
            </div>
            <div class="button-grid">
                <button onclick="game.explore()">ğŸ” æ¢ç´¢ã™ã‚‹</button>
                <button onclick="game.useItemInDungeon()">ğŸ§ª ã‚¢ã‚¤ãƒ†ãƒ ä½¿ç”¨</button>
                <button onclick="game.returnToTown()">ğŸ° ç”ºã«æˆ»ã‚‹</button>
            </div>
        </div>

        <div id="battle" class="screen battle-screen">
            <h1>âš”ï¸ æˆ¦é—˜</h1>
            <div class="enemy-info">
                <div class="enemy-name" id="enemy-name">ã‚¹ãƒ©ã‚¤ãƒ </div>
                <div class="stat">
                    <div class="stat-label">æ•µHP</div>
                    <div class="stat-value" id="enemy-hp">30/30</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="enemy-hp-bar" style="width: 100%"></div>
                    </div>
                </div>
                <div class="stat" style="margin-top: 10px;">
                    <div class="stat-label">ç¨®åˆ¥</div>
                    <div class="stat-value" id="enemy-type-label">é€šå¸¸</div>
                </div>
            </div>
            <div class="battle-log" id="battle-log"></div>
            <div class="button-grid">
                <button onclick="game.attack()">âš”ï¸ æ”»æ’ƒ</button>
                <button onclick="game.useSkill('power-strike')" id="power-strike-btn">ğŸ’¥ å¼·æ‰“ (10SP)</button>
                <button onclick="game.useSkill('heal')" id="heal-btn">ğŸ’š å›å¾© (15SP)</button>
                <button onclick="game.useItem()">ğŸ§ª ã‚¢ã‚¤ãƒ†ãƒ </button>
                <button onclick="game.flee()">ğŸƒ é€ƒã’ã‚‹</button>
            </div>
        </div>

        <div id="inventory" class="screen">
            <div style="padding: 30px;">
                <h1>ğŸ’ è£…å‚™ãƒ»ã‚¢ã‚¤ãƒ†ãƒ </h1>
                <div style="background: var(--color-bg-surface); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                        <div><strong>æ”»æ’ƒåŠ›:</strong> <span id="total-attack" style="color: var(--color-danger);">10</span></div>
                        <div><strong>é˜²å¾¡åŠ›:</strong> <span id="total-defense" style="color: var(--color-primary);">5</span></div>
                        <div><strong>HPå›å¾©è–¬:</strong> <span id="potion-count">0</span></div>
                        <div><strong>SPå›å¾©è–¬:</strong> <span id="sp-potion-count">0</span></div>
                    </div>
                </div>
                <div id="inventory-list" style="max-height: 500px; overflow-y: auto;"></div>
                <div style="margin-top: 20px;">
                    <button onclick="game.returnToTown()">ğŸ° ç”ºã«æˆ»ã‚‹</button>
                </div>
            </div>
        </div>

        <!-- å€‰åº«ç”»é¢ -->
        <div id="storage" class="screen">
            <div style="padding: 30px;">
                <h1>ğŸ“¦ å€‰åº«</h1>
                <div style="background: var(--color-bg-surface); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <p style="color: var(--color-text-secondary); margin-bottom: 10px;">
                        ä½¿ç”¨æ : <span id="storage-usage" style="color: var(--color-warning); font-weight: 600;">0/10</span>
                    </p>
                    <button onclick="game.expandStorage()" style="padding: 10px 20px; background: var(--color-warning);">
                        å€‰åº«æ‹¡å¼µ (+10æ ) - <span id="expand-cost">500</span>G
                    </button>
                </div>
                <div id="storage-list" style="max-height: 500px; overflow-y: auto;"></div>
                <div style="margin-top: 20px;">
                    <button onclick="game.returnToTown()">ğŸ° ç”ºã«æˆ»ã‚‹</button>
                </div>
            </div>
        </div>

        <div id="skills" class="screen">
            <div style="padding: 30px;">
                <h1>ğŸ“Š ã‚¹ã‚­ãƒ«ç”»é¢</h1>
                <div class="skill-points">
                    ä½¿ç”¨å¯èƒ½ã‚¹ã‚­ãƒ«ãƒã‚¤ãƒ³ãƒˆ: <span id="skill-points">0</span>
                </div>
                <div class="skills-grid">
                    <div class="skill-card">
                        <div class="skill-name">æ”»æ’ƒåŠ›</div>
                        <div class="skill-level">Lv.<span id="atk-level">1</span></div>
                        <button onclick="game.levelUpSkill('attack')" style="margin-top: 10px; padding: 8px 12px;">+1 å¼·åŒ–</button>
                    </div>
                    <div class="skill-card">
                        <div class="skill-name">é˜²å¾¡åŠ›</div>
                        <div class="skill-level">Lv.<span id="def-level">1</span></div>
                        <button onclick="game.levelUpSkill('defense')" style="margin-top: 10px; padding: 8px 12px;">+1 å¼·åŒ–</button>
                    </div>
                    <div class="skill-card">
                        <div class="skill-name">æœ€å¤§HP</div>
                        <div class="skill-level">Lv.<span id="hp-level">1</span></div>
                        <button onclick="game.levelUpSkill('hp')" style="margin-top: 10px; padding: 8px 12px;">+1 å¼·åŒ–</button>
                    </div>
                    <div class="skill-card">
                        <div class="skill-name">å¼·æ‰“ã‚¹ã‚­ãƒ«</div>
                        <div class="skill-level">Lv.<span id="power-level">0</span></div>
                        <button onclick="game.levelUpSkill('power-strike')" style="margin-top: 10px; padding: 8px 12px;">ç¿’å¾—/å¼·åŒ–</button>
                    </div>
                    <div class="skill-card">
                        <div class="skill-name">å›å¾©ã‚¹ã‚­ãƒ«</div>
                        <div class="skill-level">Lv.<span id="heal-level">0</span></div>
                        <button onclick="game.levelUpSkill('heal')" style="margin-top: 10px; padding: 8px 12px;">ç¿’å¾—/å¼·åŒ–</button>
                    </div>
                </div>
                <button onclick="game.returnToTown()" style="margin-top: 20px;">ğŸ° ç”ºã«æˆ»ã‚‹</button>
            </div>
        </div>

        <!-- é“å…·å±‹ç”»é¢ -->
        <div id="shop" class="screen">
            <div style="padding: 30px;">
                <h1>ğŸª é“å…·å±‹</h1>
                <p style="color: var(--color-text-secondary); margin-bottom: 20px;">
                    å†’é™ºã«å½¹ç«‹ã¤ã‚¢ã‚¤ãƒ†ãƒ ã‚’è²©å£²ã—ã¦ã„ã‚‹ãã€‚è£…å‚™ã®å£²å´ã‚‚ã§ãã‚‹ã€‚
                </p>

                <h2>ğŸ“¦ ã‚¢ã‚¤ãƒ†ãƒ è³¼å…¥</h2>
                <div class="button-grid">
                    <button onclick="game.buyItem('small-potion')">ğŸ å°å›å¾©è–¬ (HP30) - 20G</button>
                    <button onclick="game.buyItem('large-potion')">ğŸ å¤§å›å¾©è–¬ (HP80) - 50G</button>
                    <button onclick="game.buyItem('sp-potion')">ğŸ”· SPå›å¾©è–¬ (SP20) - 30G</button>
                    <button onclick="game.buyItem('full-potion')">âœ¨ ä¸‡èƒ½è–¬ (HP&SPå…¨å›å¾©) - 100G</button>
                    <button onclick="game.buyItem('smoke-bomb')">ğŸ’¨ ç…™ç‰ (ç¢ºå®šé€ƒèµ°) - 80G</button>
                </div>

                <h2 style="margin-top: 30px;">ğŸ’° è£…å‚™å£²å´</h2>
                <div style="margin-bottom: 15px;">
                    <button onclick="game.showShopSellInventory()" style="margin-right: 10px;">ğŸ’ ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã‹ã‚‰å£²å´</button>
                    <button onclick="game.showShopSellStorage()">ğŸ“¦ å€‰åº«ã‹ã‚‰å£²å´</button>
                </div>
                <div id="shop-sell-list" style="max-height: 400px; overflow-y: auto; background: var(--color-bg-base); padding: 15px; border-radius: 8px;">
                    <p style="color: var(--color-text-muted); text-align: center;">ä¸Šã®ãƒœã‚¿ãƒ³ã‹ã‚‰å£²å´ã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
                </div>

                <button onclick="game.returnToTown()" style="margin-top: 20px;">ğŸ° ç”ºã«æˆ»ã‚‹</button>
            </div>
        </div>

        <!-- ã‚¬ãƒãƒ£ç”»é¢ -->
        <div id="gacha" class="screen gacha-screen">
            <h1>ğŸ° ã‚¬ãƒãƒ£</h1>
            <p style="color: var(--color-text-secondary); margin-bottom: 10px;">
                é‹å‘½ã®æ‰‰ã‚’é–‹ã‘ï¼ãƒ¬ã‚¢ãªãƒ¦ãƒ‹ãƒ¼ã‚¯è£…å‚™ãŒæ‰‹ã«å…¥ã‚‹ã‹ã‚‚ï¼Ÿ
            </p>
            <p style="color: var(--color-warning); font-size: 14px; margin-bottom: 30px;">
                â€» 1å›250Gã€ä½ç¢ºç‡ã§ãƒ¦ãƒ‹ãƒ¼ã‚¯è£…å‚™ãŒå‡ºç¾ï¼
            </p>

            <div style="background: var(--color-bg-surface); padding: 30px; border-radius: 12px; margin-bottom: 30px;">
                <div style="font-size: 48px; margin-bottom: 20px;">ğŸ</div>
                <p style="color: var(--color-text-secondary); margin-bottom: 20px;">
                    æ‰€æŒé‡‘: <span id="gacha-gold" style="color: var(--color-warning); font-weight: 700;">5000</span>G
                </p>
                <button class="gacha-button" onclick="game.rollGacha()">ã‚¬ãƒãƒ£ã‚’å›ã™ (250G)</button>
            </div>

            <div id="gacha-result" style="background: var(--color-bg-surface); padding: 20px; border-radius: 8px; margin-bottom: 20px; display: none;">
                <h3 style="color: var(--color-primary); margin-bottom: 10px;">ã‚¬ãƒãƒ£çµæœ</h3>
                <div id="gacha-result-content"></div>
            </div>

            <div style="background: var(--color-bg-base); padding: 20px; border-radius: 8px; text-align: left; margin-bottom: 20px;">
                <h3 style="color: var(--color-primary); margin-bottom: 10px;">æ’å‡ºç‡</h3>
                <p style="font-size: 14px; color: var(--color-text-muted); line-height: 1.8;">
                    ãƒ¦ãƒ‹ãƒ¼ã‚¯: 3%<br>
                    ãƒ¬ã‚¸ã‚§ãƒ³ãƒ€ãƒªãƒ¼: 10%<br>
                    ã‚¨ãƒ”ãƒƒã‚¯: 20%<br>
                    ãƒ¬ã‚¢: 30%<br>
                    ã‚¢ãƒ³ã‚³ãƒ¢ãƒ³ä»¥ä¸‹: 37%
                </p>
            </div>

            <button onclick="game.returnToTown()">ğŸ° ç”ºã«æˆ»ã‚‹</button>
        </div>
    </div>

    <script>
        const game = {
            player: {
                level: 1,
                hp: 100,
                maxHp: 100,
                sp: 30,
                maxSp: 30,
                exp: 0,
                expToLevel: 120,
                gold: 5000,
                attack: 5,
                defense: 3,
                skillPoints: 0,
                skills: {
                    attack: 1,
                    defense: 1,
                    hp: 1,
                    powerStrike: 0,
                    heal: 0
                },
                inventory: [],
                inventoryMax: 20,
                storage: [],
                storageMax: 10,
                equipment: {
                    weapon: null,
                    armor: null,
                    accessory: null
                },
                items: {
                    smallPotion: 0,
                    largePotion: 0,
                    spPotion: 0,
                    fullPotion: 0
                }
            },
            enemy: null,
            dungeonDepth: 1,
            currentArea: 1,
            inBattle: false,
            roundCount: 0,
            shopSellMode: 'none',

            // ã‚¨ãƒªã‚¢æƒ…å ±
            areaInfo: {
                1: 'ã¯ã˜ã¾ã‚Šã®æ£®ã€‚é™ã‹ãªæ£®ã ãŒã€é­”ç‰©ã®æ°—é…ãŒã™ã‚‹â€¦',
                2: 'ç”ºã¸ã¨ç¶šãé“ã€‚ç›—è³Šã‚„é­”ç‰©ãŒé€šè¡Œäººã‚’ç‹™ã£ã¦ã„ã‚‹ã€‚',
                3: 'è¡—ã¯ãšã‚Œã®ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ã€‚å±é™ºãªæ°—é…ãŒç«‹ã¡è¾¼ã‚ã¦ã„ã‚‹â€¦',
                4: 'æš—é»’ã®æ£®ã€‚æ¿ƒã„éœ§ãŒç«‹ã¡è¾¼ã‚ã€å¼·åŠ›ãªé­”ç‰©ãŒå¾˜å¾Šã—ã¦ã„ã‚‹â€¦'
            },

            // æ•µãƒ†ãƒ¼ãƒ–ãƒ«
            enemyTables: {
                normal: {
                    // ã‚¨ãƒªã‚¢1ï¼š1-10ãƒ©ã‚¦ãƒ³ãƒ‰ç”¨ï¼ˆåºç›¤ï¼‰
                    '1-early': [
                        { name: 'ã‚¹ãƒ©ã‚¤ãƒ ', hp: 50, attack: 8, defense: 3, exp: 25, gold: 15 },
                        { name: 'æ£®ã­ãšã¿', hp: 45, attack: 9, defense: 2, exp: 22, gold: 12 },
                        { name: 'é‡ç”Ÿã®ã‚¦ã‚µã‚®', hp: 40, attack: 7, defense: 2, exp: 20, gold: 10 }
                    ],
                    // ã‚¨ãƒªã‚¢1ï¼š11-20ãƒ©ã‚¦ãƒ³ãƒ‰ç”¨ï¼ˆå¾ŒåŠï¼‰
                    '1-late': [
                        { name: 'å‡¶æš´ã‚¹ãƒ©ã‚¤ãƒ ', hp: 90, attack: 15, defense: 6, exp: 50, gold: 30 },
                        { name: 'æ£®ã®ç•ªçŠ¬', hp: 85, attack: 16, defense: 5, exp: 48, gold: 28 },
                        { name: 'æ£®ã®é­”ç£', hp: 95, attack: 17, defense: 7, exp: 55, gold: 32 }
                    ],
                    // ã‚¨ãƒªã‚¢2ï¼š1-10ãƒ©ã‚¦ãƒ³ãƒ‰ç”¨ï¼ˆåºç›¤ï¼‰
                    '2-early': [
                        { name: 'ãªã‚‰ãšè€…', hp: 120, attack: 18, defense: 8, exp: 80, gold: 50 },
                        { name: 'é“ã®ã‚´ãƒ–ãƒªãƒ³', hp: 110, attack: 20, defense: 7, exp: 85, gold: 45 },
                        { name: 'å±±è³Šè¦‹ç¿’ã„', hp: 100, attack: 17, defense: 6, exp: 75, gold: 40 }
                    ],
                    // ã‚¨ãƒªã‚¢2ï¼š11-20ãƒ©ã‚¦ãƒ³ãƒ‰ç”¨ï¼ˆå¾ŒåŠï¼‰
                    '2-late': [
                        { name: 'ãªã‚‰ãšè€…éšŠå“¡', hp: 200, attack: 30, defense: 13, exp: 140, gold: 80 },
                        { name: 'ã‚´ãƒ–ãƒªãƒ³æˆ¦å£«', hp: 190, attack: 32, defense: 12, exp: 145, gold: 85 },
                        { name: 'å±±è³Šãƒªãƒ¼ãƒ€ãƒ¼å€™è£œ', hp: 210, attack: 33, defense: 14, exp: 150, gold: 90 }
                    ],
                    // ã‚¨ãƒªã‚¢3ï¼š1-10ãƒ©ã‚¦ãƒ³ãƒ‰ç”¨ï¼ˆåºç›¤ï¼‰
                    '3-early': [
                        { name: 'åœ°ä¸‹ã‚¹ã‚±ãƒ«ãƒˆãƒ³', hp: 220, attack: 32, defense: 14, exp: 180, gold: 90 },
                        { name: 'ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ã‚¤ãƒ³ãƒ—', hp: 200, attack: 35, defense: 12, exp: 170, gold: 85 },
                        { name: 'å¢“åœ°ã®ã‚¾ãƒ³ãƒ“', hp: 210, attack: 30, defense: 13, exp: 175, gold: 88 }
                    ],
                    // ã‚¨ãƒªã‚¢3ï¼š11-20ãƒ©ã‚¦ãƒ³ãƒ‰ç”¨ï¼ˆå¾ŒåŠï¼‰
                    '3-late': [
                        { name: 'ã‚¹ã‚±ãƒ«ãƒˆãƒ³é¨å£«', hp: 350, attack: 52, defense: 24, exp: 280, gold: 140 },
                        { name: 'ãƒ‡ãƒ¼ãƒ¢ãƒ³ã‚¤ãƒ³ãƒ—', hp: 330, attack: 55, defense: 22, exp: 290, gold: 145 },
                        { name: 'å¤ä»£ã®äº¡éœŠ', hp: 360, attack: 54, defense: 25, exp: 285, gold: 150 }
                    ],
                    // ã‚¨ãƒªã‚¢4ï¼š1-10ãƒ©ã‚¦ãƒ³ãƒ‰ç”¨ï¼ˆåºç›¤ï¼‰
                    '4-early': [
                        { name: 'å½±ã®ç£', hp: 380, attack: 50, defense: 22, exp: 320, gold: 150 },
                        { name: 'é—‡ã®é­”å°å¸«', hp: 360, attack: 55, defense: 20, exp: 340, gold: 160 },
                        { name: 'æš—é»’ã®ä½¿ã„é­”', hp: 370, attack: 52, defense: 21, exp: 330, gold: 155 }
                    ],
                    // ã‚¨ãƒªã‚¢4ï¼š11-20ãƒ©ã‚¦ãƒ³ãƒ‰ç”¨ï¼ˆå¾ŒåŠï¼‰
                    '4-late': [
                        { name: 'å½±ã®é­”ç£', hp: 600, attack: 80, defense: 35, exp: 500, gold: 250 },
                        { name: 'é—‡ã®å¤§é­”å°å¸«', hp: 580, attack: 85, defense: 33, exp: 520, gold: 260 },
                        { name: 'æš—é»’é¨å£«', hp: 620, attack: 82, defense: 36, exp: 510, gold: 255 }
                    ]
                },
                midBoss: {
                    1: { name: 'å·¨å¤§ã‚¹ãƒ©ã‚¤ãƒ ', hp: 280, attack: 22, defense: 10, exp: 200, gold: 120 },
                    2: { name: 'ãªã‚‰ãšè€…éšŠé•·', hp: 550, attack: 38, defense: 18, exp: 450, gold: 280 },
                    3: { name: 'åœ°ä¸‹ç‰¢ã®ç•ªäºº', hp: 900, attack: 60, defense: 28, exp: 750, gold: 450 },
                    4: { name: 'é—‡ã®é¨å£«', hp: 1400, attack: 85, defense: 40, exp: 1100, gold: 700 }
                },
                boss: {
                    1: { name: 'æ£®å®ˆã‚Šã®æ¨¹éœŠ', hp: 600, attack: 35, defense: 15, exp: 500, gold: 350 },
                    2: { name: 'æ©‹ã®å®ˆè­·é¨å£«', hp: 1200, attack: 65, defense: 30, exp: 1000, gold: 650 },
                    3: { name: 'å¤ä»£ç«œã®äº¡éœŠ', hp: 2000, attack: 100, defense: 45, exp: 1600, gold: 1000 },
                    4: { name: 'æš—é»’ã®æ”¯é…è€…', hp: 3200, attack: 140, defense: 65, exp: 2500, gold: 1500 }
                }
            },

            // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆé›‘é­šãƒ»ä¸­ãƒœã‚¹ãƒ»å¤§ãƒœã‚¹åˆ¥ï¼‰
            dropTables: {
                normal: {
                    1: [
                        { name: 'æœ¨ã®å‰£', type: 'weapon', attack: 3, defense: 0, dropRate: 0.15 },
                        { name: 'å¸ƒã®æœ', type: 'armor', attack: 0, defense: 2, dropRate: 0.15 },
                        { name: 'é©ã®ãƒ™ãƒ«ãƒˆ', type: 'accessory', attack: 1, defense: 1, dropRate: 0.10 }
                    ],
                    2: [
                        { name: 'éŒ†ã³ãŸå‰£', type: 'weapon', attack: 5, defense: 0, dropRate: 0.12 },
                        { name: 'é©ã®é§', type: 'armor', attack: 0, defense: 4, dropRate: 0.12 },
                        { name: 'éŠ…ã®æŒ‡è¼ª', type: 'accessory', attack: 2, defense: 1, dropRate: 0.08 }
                    ],
                    3: [
                        { name: 'é‰„ã®å‰£', type: 'weapon', attack: 8, defense: 0, dropRate: 0.10 },
                        { name: 'é‰„ã®é§', type: 'armor', attack: 0, defense: 6, dropRate: 0.10 },
                        { name: 'éŠ€ã®æŒ‡è¼ª', type: 'accessory', attack: 3, defense: 2, dropRate: 0.07 }
                    ],
                    4: [
                        { name: 'é‹¼é‰„ã®å‰£', type: 'weapon', attack: 12, defense: 0, dropRate: 0.08 },
                        { name: 'é‹¼é‰„ã®é§', type: 'armor', attack: 0, defense: 9, dropRate: 0.08 },
                        { name: 'é—‡ã®æŒ‡è¼ª', type: 'accessory', attack: 5, defense: 3, dropRate: 0.06 }
                    ]
                },
                midBoss: {
                    1: [
                        { name: 'ã‚°ãƒªãƒ¼ãƒ³ã‚½ãƒ¼ãƒ‰', type: 'weapon', attack: 10, defense: 0 },
                        { name: 'ãƒ•ã‚©ãƒ¬ã‚¹ãƒˆã‚¢ãƒ¼ãƒãƒ¼', type: 'armor', attack: 0, defense: 8 }
                    ],
                    2: [
                        { name: 'ãƒ–ãƒªã‚¬ãƒ³ãƒ‰ãƒ–ãƒ¬ãƒ¼ãƒ‰', type: 'weapon', attack: 15, defense: 0 },
                        { name: 'ãƒ­ãƒ¼ãƒ‰ã‚¢ãƒ¼ãƒãƒ¼', type: 'armor', attack: 0, defense: 12 }
                    ],
                    3: [
                        { name: 'ãƒœãƒ¼ãƒ³ã‚¯ãƒ©ãƒƒã‚·ãƒ£ãƒ¼', type: 'weapon', attack: 20, defense: 0 },
                        { name: 'ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ãƒ¡ã‚¤ãƒ«', type: 'armor', attack: 0, defense: 16 }
                    ],
                    4: [
                        { name: 'ãƒ€ãƒ¼ã‚¯ãƒ–ãƒ¬ãƒ¼ãƒ‰', type: 'weapon', attack: 26, defense: 0 },
                        { name: 'ã‚·ãƒ£ãƒ‰ã‚¦ã‚¢ãƒ¼ãƒãƒ¼', type: 'armor', attack: 0, defense: 22 }
                    ]
                },
                boss: {
                    1: [
                        { name: 'ãƒ•ã‚©ãƒ¬ã‚¹ãƒˆã‚­ãƒ³ã‚°ã‚½ãƒ¼ãƒ‰', type: 'weapon', attack: 18, defense: 0 },
                        { name: 'ã‚¹ãƒ”ãƒªãƒƒãƒˆã‚¢ãƒ¼ãƒãƒ¼', type: 'armor', attack: 0, defense: 14 },
                        { name: 'æ¨¹éœŠã®è­·ç¬¦', type: 'accessory', attack: 6, defense: 4 }
                    ],
                    2: [
                        { name: 'ãƒŠã‚¤ãƒˆãƒ–ãƒ¬ãƒ¼ãƒ‰', type: 'weapon', attack: 24, defense: 0 },
                        { name: 'ã‚¬ãƒ¼ãƒ‡ã‚£ã‚¢ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ', type: 'armor', attack: 0, defense: 20 },
                        { name: 'å®ˆè­·ã®æŒ‡è¼ª', type: 'accessory', attack: 8, defense: 6 }
                    ],
                    3: [
                        { name: 'ãƒ‰ãƒ©ã‚´ãƒ³ã‚¹ãƒ¬ã‚¤ãƒ¤ãƒ¼', type: 'weapon', attack: 32, defense: 0 },
                        { name: 'ãƒ‰ãƒ©ã‚´ãƒ³ã‚¹ã‚±ã‚¤ãƒ«', type: 'armor', attack: 0, defense: 28 },
                        { name: 'ç«œã®å¿ƒè‡“', type: 'accessory', attack: 12, defense: 8 }
                    ],
                    4: [
                        { name: 'ãƒ€ãƒ¼ã‚¯ãƒã‚¹ãƒ–ãƒ¬ãƒ¼ãƒ‰', type: 'weapon', attack: 40, defense: 0 },
                        { name: 'ã‚¢ãƒ“ã‚¹ã‚¢ãƒ¼ãƒãƒ¼', type: 'armor', attack: 0, defense: 35 },
                        { name: 'æ”¯é…è€…ã®å† ', type: 'accessory', attack: 15, defense: 12 }
                    ]
                }
            },

            // ã‚¯ãƒªã‚¢çŠ¶æ³
            clearedAreas: [],

            // æ­¦å™¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆãƒ‘ãƒ­ãƒ‡ã‚£åï¼‰
            weaponTemplates: [
                { name: 'ã¯ã˜ã¾ã‚Šã®å‰£', tier: 'common', minAtk: 5, maxAtk: 8 },
                { name: 'è‰åˆˆã‚Šã®è–å‰£', tier: 'rare', minAtk: 13, maxAtk: 18 },
                { name: 'ã‚¨ã‚¯ã‚¹ãƒ»ã‚«ãƒªé¢¨', tier: 'epic', minAtk: 19, maxAtk: 25 },
                { name: 'æœˆå…‰ãƒ–ãƒ¬ãƒ¼ãƒ‰', tier: 'legendary', minAtk: 26, maxAtk: 35 },
                { name: 'ãƒ–ãƒ©ã‚¹ã‚¿ã‚½ãƒ¼ãƒ‰', tier: 'uncommon', minAtk: 9, maxAtk: 12 },
                { name: 'ãƒã‚µãƒ ãƒé¢¨ã‚«ã‚¿ãƒŠ', tier: 'epic', minAtk: 20, maxAtk: 26 },
                { name: 'æ‘é›¨ã£ã½ã„åˆ€', tier: 'rare', minAtk: 14, maxAtk: 19 }
            ],

            // é˜²å…·ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
            armorTemplates: [
                { name: 'æ—…ç«‹ã¡ã®æœ', tier: 'common', minDef: 3, maxDef: 5 },
                { name: 'é»’é¨å£«ã®é§ã‚‚ã©ã', tier: 'epic', minDef: 12, maxDef: 16 },
                { name: 'ç«œéª¨ãƒ—ãƒ¬ãƒ¼ãƒˆé¢¨', tier: 'legendary', minDef: 18, maxDef: 24 },
                { name: 'ç¡¬ã„é©é§', tier: 'uncommon', minDef: 6, maxDef: 8 },
                { name: 'ãƒŸã‚¹ãƒªãƒ«é¢¨ãƒ­ãƒ¼ãƒ–', tier: 'rare', minDef: 9, maxDef: 12 }
            ],

            // ã‚¢ãƒ•ã‚£ãƒƒã‚¯ã‚¹ï¼ˆè¿½åŠ èƒ½åŠ›ï¼‰
            affixes: {
                positive: [
                    { name: 'å¸å‘½ã®', effect: 'lifesteal', value: 3, description: 'ä¸ãƒ€ãƒ¡ãƒ¼ã‚¸ã®3%HPå›å¾©' },
                    { name: 'è¿…é€Ÿãª', effect: 'doubleAttack', value: 20, description: '20%ã§è¿½æ’ƒç™ºå‹•' },
                    { name: 'é ‘ä¸ˆãª', effect: 'hpBonus', value: 50, description: 'æœ€å¤§HP+50' },
                    { name: 'é‰„å£ã®', effect: 'defBonus', value: 10, description: 'é˜²å¾¡åŠ›+10' },
                    { name: 'SPå›å¾©ã®', effect: 'spRegen', value: 5, description: 'æ”»æ’ƒæ™‚SP+5å›å¾©' },
                    { name: 'å‰›åŠ›ã®', effect: 'atkBonus', value: 15, description: 'æ”»æ’ƒåŠ›+15' },
                    { name: 'ä¼šå¿ƒã®', effect: 'critical', value: 15, description: '15%ã§ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«(2å€)' },
                    { name: 'å†ç”Ÿã®', effect: 'hpRegen', value: 3, description: 'ã‚¿ãƒ¼ãƒ³æ¯ã«HP+3%å›å¾©' },
                    { name: 'å®ˆè­·ã®', effect: 'damageReduction', value: 10, description: 'è¢«ãƒ€ãƒ¡ãƒ¼ã‚¸10%è»½æ¸›' }
                ],
                negative: [
                    { name: 'å‘ªã‚ã‚ŒãŸ', effect: 'damageTaken', value: 15, description: 'è¢«ãƒ€ãƒ¡ãƒ¼ã‚¸15%å¢—åŠ ' },
                    { name: 'éˆé‡ãª', effect: 'atkPenalty', value: 10, description: 'æ”»æ’ƒåŠ›-10' }
                ]
            },

            // ãƒ¦ãƒ‹ãƒ¼ã‚¯è£…å‚™
            uniqueItems: [
                { name: 'å§‹ã¾ã‚Šã®æ£®ã‚’è¦‹å®ˆã‚‹å‰£', type: 'weapon', attack: 32, defense: 0, affixes: ['å¸å‘½ã®', 'SPå›å¾©ã®'] },
                { name: 'ä¼èª¬ã®å†’é™ºè€…ã®é§', type: 'armor', attack: 0, defense: 28, affixes: ['é ‘ä¸ˆãª', 'é‰„å£ã®'] },
                { name: 'é‹å‘½ã‚’åˆ‡ã‚Šé–‹ãåŒåˆƒ', type: 'weapon', attack: 35, defense: 5, affixes: ['è¿…é€Ÿãª', 'å¸å‘½ã®'] }
            ],

            init() {
                this.updateUI();
                this.showScreen('town');
            },

            showScreen(screenId) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(screenId).classList.add('active');
            },

            updateUI() {
                document.getElementById('level').textContent = this.player.level;
                document.getElementById('hp').textContent = `${this.player.hp}/${this.player.maxHp}`;
                document.getElementById('sp').textContent = `${this.player.sp}/${this.player.maxSp}`;
                document.getElementById('exp').textContent = `${this.player.exp}/${this.player.expToLevel}`;
                document.getElementById('gold').textContent = this.player.gold;
                
                if (document.getElementById('skill-points')) {
                    document.getElementById('skill-points').textContent = this.player.skillPoints;
                }

                if (document.getElementById('gacha-gold')) {
                    document.getElementById('gacha-gold').textContent = this.player.gold;
                }

                const hpPercent = Math.max(0, (this.player.hp / this.player.maxHp) * 100);
                document.getElementById('hp-bar').style.width = `${hpPercent}%`;

                const spPercent = Math.max(0, (this.player.sp / this.player.maxSp) * 100);
                document.getElementById('sp-bar').style.width = `${spPercent}%`;

                const expPercent = Math.max(0, (this.player.exp / this.player.expToLevel) * 100);
                document.getElementById('exp-bar').style.width = `${expPercent}%`;

                // ã‚¨ãƒªã‚¢è¡¨ç¤º
                const areaLabels = { 1: 'ã¯ã˜ã¾ã‚Šã®æ£®', 2: 'ç”ºã¸ã¨ç¶šãé“', 3: 'è¡—ã¯ãšã‚Œã®ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³', 4: 'æš—é»’ã®æ£®' };
                document.getElementById('current-area-label').textContent = areaLabels[this.currentArea];

                // ã‚¨ãƒªã‚¢ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹åŒ–
                if (document.getElementById('area2-btn')) {
                    document.getElementById('area2-btn').disabled = !this.clearedAreas.includes(1);
                    document.getElementById('area3-btn').disabled = !this.clearedAreas.includes(2);
                    document.getElementById('area4-btn').disabled = !this.clearedAreas.includes(3);
                }

                if (document.getElementById('atk-level')) {
                    document.getElementById('atk-level').textContent = this.player.skills.attack;
                    document.getElementById('def-level').textContent = this.player.skills.defense;
                    document.getElementById('hp-level').textContent = this.player.skills.hp;
                    document.getElementById('power-level').textContent = this.player.skills.powerStrike;
                    document.getElementById('heal-level').textContent = this.player.skills.heal;
                }

                const stats = this.calculateStats();
                if (document.getElementById('total-attack')) {
                    document.getElementById('total-attack').textContent = stats.attack;
                    document.getElementById('total-defense').textContent = stats.defense;
                }

                if (document.getElementById('potion-count')) {
                    document.getElementById('potion-count').textContent = this.player.items.smallPotion + this.player.items.largePotion;
                    document.getElementById('sp-potion-count').textContent = this.player.items.spPotion;
                }
                
                // ç…™ç‰ã®è¡¨ç¤ºãŒã‚ã‚‹å ´åˆã¯æ›´æ–°ï¼ˆä»Šå¾Œã®æ‹¡å¼µç”¨ï¼‰
                if (document.getElementById('smoke-bomb-count')) {
                    document.getElementById('smoke-bomb-count').textContent = this.player.items.smokeBomb || 0;
                }

                if (document.getElementById('storage-count')) {
                    document.getElementById('storage-count').textContent = this.player.storage.length;
                    document.getElementById('storage-max').textContent = this.player.storageMax;
                }

                if (document.getElementById('inventory-count')) {
                    document.getElementById('inventory-count').textContent = this.player.inventory.length;
                    document.getElementById('inventory-max').textContent = this.player.inventoryMax;
                }

                if (document.getElementById('dungeon-area-text')) {
                    document.getElementById('dungeon-area-text').textContent = this.areaInfo[this.currentArea];
                }

                if (document.getElementById('dungeon-depth')) {
                    document.getElementById('dungeon-depth').textContent = `${this.roundCount}/20`;
                }
            },

            selectArea(areaId) {
                // ã‚¨ãƒªã‚¢ãƒ­ãƒƒã‚¯ç¢ºèª
                if (areaId === 2 && !this.clearedAreas.includes(1)) {
                    alert('ã‚¨ãƒªã‚¢1ã‚’ã‚¯ãƒªã‚¢ã—ãªã„ã¨é€²ã‚ã¾ã›ã‚“ï¼');
                    return;
                }
                if (areaId === 3 && !this.clearedAreas.includes(2)) {
                    alert('ã‚¨ãƒªã‚¢2ã‚’ã‚¯ãƒªã‚¢ã—ãªã„ã¨é€²ã‚ã¾ã›ã‚“ï¼');
                    return;
                }
                if (areaId === 4 && !this.clearedAreas.includes(3)) {
                    alert('ã‚¨ãƒªã‚¢3ã‚’ã‚¯ãƒªã‚¢ã—ãªã„ã¨é€²ã‚ã¾ã›ã‚“ï¼');
                    return;
                }

                this.currentArea = areaId;
                this.dungeonDepth = 1;
                this.roundCount = 0;
                this.updateUI();
                const areaLabels = { 1: 'ã¯ã˜ã¾ã‚Šã®æ£®', 2: 'ç”ºã¸ã¨ç¶šãé“', 3: 'è¡—ã¯ãšã‚Œã®ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³', 4: 'æš—é»’ã®æ£®' };
                alert(`ã‚¨ãƒªã‚¢ã‚’ã€Œ${areaLabels[areaId]}ã€ã«å¤‰æ›´ã—ãŸï¼`);
            },

            enterDungeon() {
                this.dungeonDepth = 1;
                this.roundCount = 0;
                this.updateUI();
                this.showScreen('dungeon');
            },

            explore() {
                if (this.inBattle) return;
                
                this.roundCount++;
                
                // 10ãƒ©ã‚¦ãƒ³ãƒ‰ç›®ã¯ä¸­ãƒœã‚¹ã€20ãƒ©ã‚¦ãƒ³ãƒ‰ç›®ã¯å¤§ãƒœã‚¹
                if (this.roundCount === 10) {
                    alert('å¼·åŠ›ãªæ°—é…ã‚’æ„Ÿã˜ã‚‹â€¦ä¸­ãƒœã‚¹ãŒç¾ã‚ŒãŸï¼');
                    this.startBattle('midBoss');
                    return;
                } else if (this.roundCount === 20) {
                    alert('åœ§å€’çš„ãªå¨åœ§æ„Ÿâ€¦å¤§ãƒœã‚¹ãŒç¾ã‚ŒãŸï¼');
                    this.startBattle('boss');
                    return;
                } else if (this.roundCount > 20) {
                    // 20ãƒ©ã‚¦ãƒ³ãƒ‰è¶…éæ™‚ã¯ç”ºã«æˆ»ã‚‹
                    alert('ã‚¨ãƒªã‚¢ã‚’è¸ç ´ã—ãŸï¼ç”ºã«æˆ»ã‚Šã¾ã™ã€‚');
                    this.returnToTown();
                    return;
                }
                
                // é€šå¸¸ã®æ•µã‚¨ãƒ³ã‚«ã‚¦ãƒ³ãƒˆï¼ˆ1-10ã¨11-20ã§ç•°ãªã‚‹æ•µï¼‰
                const encounter = Math.random();
                if (encounter < 0.7) {
                    const phase = this.roundCount <= 10 ? 'early' : 'late';
                    this.startBattle('normal', phase);
                } else {
                    this.dungeonDepth++;
                    this.updateUI();
                    alert(`ãƒ©ã‚¦ãƒ³ãƒ‰${this.roundCount} - ã•ã‚‰ã«å¥¥ã¸é€²ã‚“ã â€¦`);
                }
            },

            useItemInDungeon() {
                const itemsDiv = document.createElement('div');
                itemsDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--color-bg-elevated); padding: 30px; border-radius: 12px; z-index: 1000; max-width: 400px; box-shadow: 0 20px 60px rgba(0,0,0,0.8);';
                
                itemsDiv.innerHTML = `
                    <h3 style="color: var(--color-primary); margin-bottom: 20px;">ã‚¢ã‚¤ãƒ†ãƒ ä½¿ç”¨</h3>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button onclick="game.useItemQuick('smallPotion', 30, 'hp'); this.parentElement.parentElement.remove();" ${this.player.items.smallPotion > 0 ? '' : 'disabled'}>
                            ğŸ å°å›å¾©è–¬ (${this.player.items.smallPotion}å€‹) - HP30å›å¾©
                        </button>
                        <button onclick="game.useItemQuick('largePotion', 80, 'hp'); this.parentElement.parentElement.remove();" ${this.player.items.largePotion > 0 ? '' : 'disabled'}>
                            ğŸ å¤§å›å¾©è–¬ (${this.player.items.largePotion}å€‹) - HP80å›å¾©
                        </button>
                        <button onclick="game.useItemQuick('spPotion', 20, 'sp'); this.parentElement.parentElement.remove();" ${this.player.items.spPotion > 0 ? '' : 'disabled'}>
                            ğŸ”· SPå›å¾©è–¬ (${this.player.items.spPotion}å€‹) - SP20å›å¾©
                        </button>
                        <button onclick="game.useItemQuick('fullPotion', 'full', 'both'); this.parentElement.parentElement.remove();" ${this.player.items.fullPotion > 0 ? '' : 'disabled'}>
                            âœ¨ ä¸‡èƒ½è–¬ (${this.player.items.fullPotion}å€‹) - HP&SPå…¨å›å¾©
                        </button>
                        <button onclick="this.parentElement.parentElement.remove();" style="margin-top: 10px; background: var(--color-bg-surface);">
                            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </button>
                    </div>
                `;
                
                document.body.appendChild(itemsDiv);
            },

            useItemQuick(itemType, amount, stat) {
                if (this.player.items[itemType] <= 0) return;
                
                this.player.items[itemType]--;
                
                if (stat === 'hp') {
                    this.player.hp = Math.min(this.player.maxHp, this.player.hp + amount);
                    alert(`HP${amount}å›å¾©ã—ãŸï¼`);
                } else if (stat === 'sp') {
                    this.player.sp = Math.min(this.player.maxSp, this.player.sp + amount);
                    alert(`SP${amount}å›å¾©ã—ãŸï¼`);
                } else if (stat === 'both') {
                    this.player.hp = this.player.maxHp;
                    this.player.sp = this.player.maxSp;
                    alert('HP&SPå…¨å›å¾©ã—ãŸï¼');
                }
                
                this.updateUI();
            },

            useItemInDungeonOld() {
                let itemList = '=== ã‚¢ã‚¤ãƒ†ãƒ ä½¿ç”¨ ===\n\n';
                itemList += `1. å°å›å¾©è–¬ (${this.player.items.smallPotion}å€‹) - HP30å›å¾©\n`;
                itemList += `2. å¤§å›å¾©è–¬ (${this.player.items.largePotion}å€‹) - HP80å›å¾©\n`;
                itemList += `3. SPå›å¾©è–¬ (${this.player.items.spPotion}å€‹) - SP20å›å¾©\n`;
                itemList += `4. ä¸‡èƒ½è–¬ (${this.player.items.fullPotion}å€‹) - HP&SPå…¨å›å¾©\n`;
                itemList += '5. ã‚­ãƒ£ãƒ³ã‚»ãƒ«\n';

                const choice = prompt(itemList + '\nç•ªå·ã‚’å…¥åŠ›:');

                if (choice === '1' && this.player.items.smallPotion > 0) {
                    this.player.items.smallPotion--;
                    this.player.hp = Math.min(this.player.maxHp, this.player.hp + 30);
                    alert('å°å›å¾©è–¬ã§HP30å›å¾©ï¼');
                    this.updateUI();
                } else if (choice === '2' && this.player.items.largePotion > 0) {
                    this.player.items.largePotion--;
                    this.player.hp = Math.min(this.player.maxHp, this.player.hp + 80);
                    alert('å¤§å›å¾©è–¬ã§HP80å›å¾©ï¼');
                    this.updateUI();
                } else if (choice === '3' && this.player.items.spPotion > 0) {
                    this.player.items.spPotion--;
                    this.player.sp = Math.min(this.player.maxSp, this.player.sp + 20);
                    alert('SPå›å¾©è–¬ã§SP20å›å¾©ï¼');
                    this.updateUI();
                } else if (choice === '4' && this.player.items.fullPotion > 0) {
                    this.player.items.fullPotion--;
                    this.player.hp = this.player.maxHp;
                    this.player.sp = this.player.maxSp;
                    alert('ä¸‡èƒ½è–¬ã§HP&SPå…¨å›å¾©ï¼');
                    this.updateUI();
                } else if (choice && choice !== '5') {
                    alert('ãã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’æŒã£ã¦ã„ãªã„ï¼');
                }
            },

            startBattle(type = 'normal', phase = 'early') {
                this.inBattle = true;

                if (type === 'normal') {
                    const key = `${this.currentArea}-${phase}`;
                    const list = this.enemyTables.normal[key];
                    const base = list[Math.floor(Math.random() * list.length)];
                    const depthFactor = 1 + (this.dungeonDepth - 1) * 0.1;
                    this.enemy = {
                        ...base,
                        hp: Math.floor(base.hp * depthFactor),
                        attack: Math.floor(base.attack * depthFactor),
                        defense: Math.floor(base.defense * depthFactor),
                        type: 'é€šå¸¸'
                    };
                } else if (type === 'midBoss') {
                    const base = this.enemyTables.midBoss[this.currentArea];
                    const depthFactor = 1 + (this.dungeonDepth - 1) * 0.1;
                    this.enemy = {
                        ...base,
                        hp: Math.floor(base.hp * depthFactor),
                        attack: Math.floor(base.attack * depthFactor),
                        defense: Math.floor(base.defense * depthFactor),
                        type: 'ä¸­ãƒœã‚¹'
                    };
                } else {
                    const base = this.enemyTables.boss[this.currentArea];
                    const depthFactor = 1 + (this.dungeonDepth - 1) * 0.15;
                    this.enemy = {
                        ...base,
                        hp: Math.floor(base.hp * depthFactor),
                        attack: Math.floor(base.attack * depthFactor),
                        defense: Math.floor(base.defense * depthFactor),
                        type: 'å¤§ãƒœã‚¹'
                    };
                }

                this.enemy.maxHp = this.enemy.hp;

                document.getElementById('enemy-name').textContent = this.enemy.name;
                document.getElementById('enemy-type-label').textContent = this.enemy.type;
                this.updateEnemyUI();
                this.clearBattleLog();
                this.addBattleLog(`${this.enemy.name}ãŒç¾ã‚ŒãŸï¼ï¼ˆ${this.enemy.type}ï¼‰`);
                this.showScreen('battle');
            },

            updateEnemyUI() {
                if (!this.enemy) return;
                const safeHp = Math.max(0, this.enemy.hp);
                document.getElementById('enemy-hp').textContent = `${safeHp}/${this.enemy.maxHp}`;
                const hpPercent = Math.max(0, (safeHp / this.enemy.maxHp) * 100);
                document.getElementById('enemy-hp-bar').style.width = `${hpPercent}%`;
            },

            playerTurnGuard() {
                if (!this.inBattle || !this.enemy) return false;
                if (this.enemy.hp <= 0 || this.player.hp <= 0) return false;
                return true;
            },

            clearBattleLog() {
                document.getElementById('battle-log').innerHTML = '';
            },

            addBattleLog(message, type = '') {
                const log = document.getElementById('battle-log');
                const entry = document.createElement('div');
                entry.className = `log-entry ${type}`;
                entry.textContent = message;
                log.appendChild(entry);
                log.scrollTop = log.scrollHeight;
            },

            attack() {
                if (!this.playerTurnGuard()) return;

                const stats = this.calculateStats();
                const baseAtk = stats.attack;
                const damage = Math.max(1, Math.floor(baseAtk - this.enemy.defense));
                this.enemy.hp -= damage;
                if (this.enemy.hp < 0) this.enemy.hp = 0;
                this.addBattleLog(`${damage}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆãŸï¼`, 'damage');
                this.updateEnemyUI();

                // ã‚¢ãƒ•ã‚£ãƒƒã‚¯ã‚¹åŠ¹æœé©ç”¨
                this.applyAffixEffects(damage);

                if (this.enemy.hp <= 0) {
                    this.victory();
                    return;
                }
                this.enemyTurn();
            },

            useSkill(skillName) {
                if (!this.playerTurnGuard()) return;

                if (skillName === 'power-strike') {
                    if (this.player.skills.powerStrike <= 0) {
                        this.addBattleLog('å¼·æ‰“ã‚¹ã‚­ãƒ«ã‚’ã¾ã ç¿’å¾—ã—ã¦ã„ãªã„ï¼');
                        return;
                    }
                    const cost = 10;
                    if (this.player.sp < cost) {
                        this.addBattleLog('SPãŒè¶³ã‚Šãªã„ï¼');
                        return;
                    }
                    this.player.sp -= cost;
                    const stats = this.calculateStats();
                    const baseAtk = stats.attack * 2.5;
                    const damage = Math.max(1, Math.floor(baseAtk - this.enemy.defense));
                    this.enemy.hp -= damage;
                    if (this.enemy.hp < 0) this.enemy.hp = 0;
                    this.addBattleLog(`å¼·æ‰“ï¼${damage}ã®å¤§ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`, 'damage');
                    this.updateEnemyUI();
                    this.updateUI();

                    this.applyAffixEffects(damage);

                    if (this.enemy.hp <= 0) {
                        this.victory();
                        return;
                    }
                    this.enemyTurn();
                } else if (skillName === 'heal') {
                    if (this.player.skills.heal <= 0) {
                        this.addBattleLog('å›å¾©ã‚¹ã‚­ãƒ«ã‚’ã¾ã ç¿’å¾—ã—ã¦ã„ãªã„ï¼');
                        return;
                    }
                    const cost = 15;
                    if (this.player.sp < cost) {
                        this.addBattleLog('SPãŒè¶³ã‚Šãªã„ï¼');
                        return;
                    }
                    this.player.sp -= cost;
                    const healAmount = Math.floor(30 * this.player.skills.heal);
                    this.player.hp = Math.min(this.player.maxHp, this.player.hp + healAmount);
                    this.addBattleLog(`${healAmount}HPå›å¾©ã—ãŸï¼`, 'heal');
                    this.updateUI();
                    this.enemyTurn();
                }
            },

            applyAffixEffects(damage) {
                ['weapon', 'armor', 'accessory'].forEach(slot => {
                    const item = this.player.equipment[slot];
                    if (!item || !item.affixes) return;

                    item.affixes.forEach(affix => {
                        if (affix.effect === 'lifesteal') {
                            const heal = Math.floor(damage * affix.value / 100);
                            this.player.hp = Math.min(this.player.maxHp, this.player.hp + heal);
                            this.addBattleLog(`å¸å‘½åŠ¹æœã§${heal}HPå›å¾©ï¼`, 'heal');
                        } else if (affix.effect === 'doubleAttack' && Math.random() * 100 < affix.value) {
                            const extraDmg = Math.floor(damage * 0.5);
                            this.enemy.hp -= extraDmg;
                            if (this.enemy.hp < 0) this.enemy.hp = 0;
                            this.addBattleLog(`è¿½æ’ƒï¼${extraDmg}ã®è¿½åŠ ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`, 'damage');
                        } else if (affix.effect === 'spRegen') {
                            this.player.sp = Math.min(this.player.maxSp, this.player.sp + affix.value);
                            this.addBattleLog(`SPå›å¾©åŠ¹æœã§${affix.value}SPå›å¾©ï¼`, 'heal');
                        } else if (affix.effect === 'critical' && Math.random() * 100 < affix.value) {
                            const critDmg = damage;
                            this.enemy.hp -= critDmg;
                            if (this.enemy.hp < 0) this.enemy.hp = 0;
                            this.addBattleLog(`ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ï¼${critDmg}ã®è¿½åŠ ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`, 'damage');
                        } else if (affix.effect === 'hpRegen') {
                            const regenHeal = Math.floor(this.player.maxHp * affix.value / 100);
                            this.player.hp = Math.min(this.player.maxHp, this.player.hp + regenHeal);
                            this.addBattleLog(`å†ç”ŸåŠ¹æœã§${regenHeal}HPå›å¾©ï¼`, 'heal');
                        }
                    });
                });
                this.updateUI();
                this.updateEnemyUI();
            },

            useItem() {
                if (!this.inBattle) return;

                const itemsDiv = document.createElement('div');
                itemsDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--color-bg-elevated); padding: 30px; border-radius: 12px; z-index: 1000; max-width: 400px; box-shadow: 0 20px 60px rgba(0,0,0,0.8);';
                
                itemsDiv.innerHTML = `
                    <h3 style="color: var(--color-primary); margin-bottom: 20px;">ã‚¢ã‚¤ãƒ†ãƒ ä½¿ç”¨</h3>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button onclick="game.useItemBattle('smallPotion', 30, 'hp'); this.parentElement.parentElement.remove();" ${this.player.items.smallPotion > 0 ? '' : 'disabled'}>
                            ğŸ å°å›å¾©è–¬ (${this.player.items.smallPotion}å€‹) - HP30å›å¾©
                        </button>
                        <button onclick="game.useItemBattle('largePotion', 80, 'hp'); this.parentElement.parentElement.remove();" ${this.player.items.largePotion > 0 ? '' : 'disabled'}>
                            ğŸ å¤§å›å¾©è–¬ (${this.player.items.largePotion}å€‹) - HP80å›å¾©
                        </button>
                        <button onclick="game.useItemBattle('spPotion', 20, 'sp'); this.parentElement.parentElement.remove();" ${this.player.items.spPotion > 0 ? '' : 'disabled'}>
                            ğŸ”· SPå›å¾©è–¬ (${this.player.items.spPotion}å€‹) - SP20å›å¾©
                        </button>
                        <button onclick="game.useItemBattle('fullPotion', 'full', 'both'); this.parentElement.parentElement.remove();" ${this.player.items.fullPotion > 0 ? '' : 'disabled'}>
                            âœ¨ ä¸‡èƒ½è–¬ (${this.player.items.fullPotion}å€‹) - HP&SPå…¨å›å¾©
                        </button>
                        <button onclick="game.useSmokeBomb(); this.parentElement.parentElement.remove();" ${(this.player.items.smokeBomb || 0) > 0 ? '' : 'disabled'}>
                            ğŸ’¨ ç…™ç‰ (${this.player.items.smokeBomb || 0}å€‹) - ç¢ºå®šé€ƒèµ°
                        </button>
                        <button onclick="this.parentElement.parentElement.remove();" style="margin-top: 10px; background: var(--color-bg-surface);">
                            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </button>
                    </div>
                `;
                
                document.body.appendChild(itemsDiv);
            },

            useItemBattle(itemType, amount, stat) {
                if (this.player.items[itemType] <= 0) return;
                
                this.player.items[itemType]--;
                
                if (stat === 'hp') {
                    this.player.hp = Math.min(this.player.maxHp, this.player.hp + amount);
                    this.addBattleLog(`${amount}HPå›å¾©ã—ãŸï¼`, 'heal');
                } else if (stat === 'sp') {
                    this.player.sp = Math.min(this.player.maxSp, this.player.sp + amount);
                    this.addBattleLog(`${amount}SPå›å¾©ã—ãŸï¼`, 'heal');
                } else if (stat === 'both') {
                    this.player.hp = this.player.maxHp;
                    this.player.sp = this.player.maxSp;
                    this.addBattleLog('HP&SPå…¨å›å¾©ã—ãŸï¼', 'heal');
                }
                
                this.updateUI();
                this.enemyTurn();
            },

            useSmokeBomb() {
                if ((this.player.items.smokeBomb || 0) <= 0) return;
                
                this.player.items.smokeBomb--;
                this.addBattleLog('ç…™ç‰ã‚’ä½¿ã£ãŸï¼ç¢ºå®Ÿã«é€ƒã’å‡ºã—ãŸï¼');
                this.inBattle = false;
                this.enemy = null;
                setTimeout(() => this.showScreen('dungeon'), 800);
                this.updateUI();
            },

            useItemOld() {
                if (!this.inBattle) return;

                let itemList = '=== ã‚¢ã‚¤ãƒ†ãƒ ä½¿ç”¨ ===\n\n';
                itemList += `1. å°å›å¾©è–¬ (${this.player.items.smallPotion}å€‹) - HP30å›å¾©\n`;
                itemList += `2. å¤§å›å¾©è–¬ (${this.player.items.largePotion}å€‹) - HP80å›å¾©\n`;
                itemList += `3. SPå›å¾©è–¬ (${this.player.items.spPotion}å€‹) - SP20å›å¾©\n`;
                itemList += `4. ä¸‡èƒ½è–¬ (${this.player.items.fullPotion}å€‹) - HP&SPå…¨å›å¾©\n`;
                itemList += `5. ç…™ç‰ (${this.player.items.smokeBomb || 0}å€‹) - ç¢ºå®šã§é€ƒèµ°æˆåŠŸ\n`;
                itemList += '6. ã‚­ãƒ£ãƒ³ã‚»ãƒ«\n';

                const choice = prompt(itemList + '\nç•ªå·ã‚’å…¥åŠ›:');

                if (choice === '1' && this.player.items.smallPotion > 0) {
                    this.player.items.smallPotion--;
                    this.player.hp = Math.min(this.player.maxHp, this.player.hp + 30);
                    this.addBattleLog('å°å›å¾©è–¬ã§HP30å›å¾©ï¼', 'heal');
                    this.updateUI();
                    this.enemyTurn();
                } else if (choice === '2' && this.player.items.largePotion > 0) {
                    this.player.items.largePotion--;
                    this.player.hp = Math.min(this.player.maxHp, this.player.hp + 80);
                    this.addBattleLog('å¤§å›å¾©è–¬ã§HP80å›å¾©ï¼', 'heal');
                    this.updateUI();
                    this.enemyTurn();
                } else if (choice === '3' && this.player.items.spPotion > 0) {
                    this.player.items.spPotion--;
                    this.player.sp = Math.min(this.player.maxSp, this.player.sp + 20);
                    this.addBattleLog('SPå›å¾©è–¬ã§SP20å›å¾©ï¼', 'heal');
                    this.updateUI();
                    this.enemyTurn();
                } else if (choice === '4' && this.player.items.fullPotion > 0) {
                    this.player.items.fullPotion--;
                    this.player.hp = this.player.maxHp;
                    this.player.sp = this.player.maxSp;
                    this.addBattleLog('ä¸‡èƒ½è–¬ã§HP&SPå…¨å›å¾©ï¼', 'heal');
                    this.updateUI();
                    this.enemyTurn();
                } else if (choice === '5' && (this.player.items.smokeBomb || 0) > 0) {
                    this.player.items.smokeBomb--;
                    this.addBattleLog('ç…™ç‰ã‚’ä½¿ã£ãŸï¼ç¢ºå®Ÿã«é€ƒã’å‡ºã—ãŸï¼');
                    this.inBattle = false;
                    this.enemy = null;
                    setTimeout(() => this.showScreen('dungeon'), 800);
                } else if (choice && choice !== '6') {
                    this.addBattleLog('ãã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’æŒã£ã¦ã„ãªã„ï¼');
                }
            },

            enemyTurn() {
                if (!this.inBattle || !this.enemy) return;
                if (this.enemy.hp <= 0) return;

                setTimeout(() => {
                    if (this.enemy.hp <= 0 || this.player.hp <= 0) return;

                    const stats = this.calculateStats();
                    let damage = Math.max(1, Math.floor(this.enemy.attack - stats.defense));
                    
                    // ãƒ€ãƒ¡ãƒ¼ã‚¸è»½æ¸›åŠ¹æœ
                    let damageReduction = 0;
                    ['weapon', 'armor', 'accessory'].forEach(slot => {
                        const item = this.player.equipment[slot];
                        if (item && item.affixes) {
                            item.affixes.forEach(affix => {
                                if (affix.effect === 'damageReduction') {
                                    damageReduction += affix.value;
                                } else if (affix.effect === 'damageTaken') {
                                    damage = Math.floor(damage * (1 + affix.value / 100));
                                }
                            });
                        }
                    });
                    
                    if (damageReduction > 0) {
                        damage = Math.floor(damage * (1 - damageReduction / 100));
                        this.addBattleLog(`å®ˆè­·åŠ¹æœã§${damageReduction}%è»½æ¸›ï¼`, 'heal');
                    }
                    
                    this.player.hp -= damage;
                    if (this.player.hp < 0) this.player.hp = 0;
                    this.addBattleLog(`${this.enemy.name}ã®æ”»æ’ƒï¼${damage}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸï¼`, 'damage');
                    this.updateUI();

                    if (this.player.hp <= 0) {
                        this.gameOver();
                    }
                }, 500);
            },

            victory() {
                if (!this.enemy) return;

                const gainedExp = this.enemy.exp;
                const gainedGold = this.enemy.gold;
                const enemyType = this.enemy.type;

                this.player.exp += gainedExp;
                this.player.gold += gainedGold;

                this.addBattleLog(`${this.enemy.name}ã‚’å€’ã—ãŸï¼`, 'level-up');
                this.addBattleLog(`${gainedExp}EXPã€${gainedGold}ã‚´ãƒ¼ãƒ«ãƒ‰ã‚’ç²å¾—ï¼`, 'level-up');

                this.checkLevelUp();

                // ãƒ‰ãƒ­ãƒƒãƒ—åˆ¤å®š
                let droppedItem = null;
                
                if (enemyType === 'é€šå¸¸') {
                    // é›‘é­šæ•µï¼šä½ç¢ºç‡ã§å¼±ã„è£…å‚™ï¼ˆã•ã‚‰ã«ä½ç¢ºç‡ã§ã‚¢ãƒ•ã‚£ãƒƒã‚¯ã‚¹ä»˜ãï¼‰
                    const dropTable = this.dropTables.normal[this.currentArea] || this.dropTables.normal[1];
                    for (let item of dropTable) {
                        if (Math.random() < item.dropRate) {
                            droppedItem = {
                                id: Date.now() + Math.random(),
                                name: item.name,
                                type: item.type,
                                attack: item.attack,
                                defense: item.defense,
                                rarity: 'ã‚³ãƒ¢ãƒ³',
                                color: '#94a3b8',
                                affixes: []
                            };
                            
                            // 15%ã§ã‚¢ãƒ•ã‚£ãƒƒã‚¯ã‚¹ä»˜ä¸ï¼ˆåŠ¹æœã¯ä½ã‚ï¼‰
                            if (Math.random() < 0.15) {
                                const weakAffixes = [
                                    { name: 'å¾®å¼±å¸å‘½ã®', effect: 'lifesteal', value: 1, description: 'ä¸ãƒ€ãƒ¡ãƒ¼ã‚¸ã®1%HPå›å¾©' },
                                    { name: 'å¾®é€Ÿã®', effect: 'doubleAttack', value: 8, description: '8%ã§è¿½æ’ƒç™ºå‹•' },
                                    { name: 'å°é ‘ä¸ˆãª', effect: 'hpBonus', value: 20, description: 'æœ€å¤§HP+20' },
                                    { name: 'å°é‰„å£ã®', effect: 'defBonus', value: 3, description: 'é˜²å¾¡åŠ›+3' },
                                    { name: 'å¾®SPå›å¾©ã®', effect: 'spRegen', value: 2, description: 'æ”»æ’ƒæ™‚SP+2å›å¾©' },
                                    { name: 'å°å‰›åŠ›ã®', effect: 'atkBonus', value: 5, description: 'æ”»æ’ƒåŠ›+5' }
                                ];
                                const affix = weakAffixes[Math.floor(Math.random() * weakAffixes.length)];
                                droppedItem.affixes.push(affix);
                                droppedItem.name = `${affix.name}${droppedItem.name}`;
                                droppedItem.rarity = 'ã‚¢ãƒ³ã‚³ãƒ¢ãƒ³';
                                droppedItem.color = '#22c55e';
                            }
                            break;
                        }
                    }
                } else if (enemyType === 'ä¸­ãƒœã‚¹') {
                    // ä¸­ãƒœã‚¹ï¼š50%ç¢ºç‡ã§ä¸­ç´šè£…å‚™ï¼ˆã‚¢ãƒ•ã‚£ãƒƒã‚¯ã‚¹ä»˜ãï¼‰
                    if (Math.random() < 0.5) {
                        const dropTable = this.dropTables.midBoss[this.currentArea];
                        const item = dropTable[Math.floor(Math.random() * dropTable.length)];
                        droppedItem = {
                            id: Date.now() + Math.random(),
                            name: item.name,
                            type: item.type,
                            attack: item.attack,
                            defense: item.defense,
                            rarity: 'ãƒ¬ã‚¢',
                            color: '#3b82f6',
                            affixes: []
                        };
                        
                        // 30%ã§ã‚¢ãƒ•ã‚£ãƒƒã‚¯ã‚¹ä»˜ä¸
                        if (Math.random() < 0.3) {
                            const affix = this.affixes.positive[Math.floor(Math.random() * this.affixes.positive.length)];
                            droppedItem.affixes.push(affix);
                            droppedItem.name = `${affix.name}${droppedItem.name}`;
                            droppedItem.rarity = 'ã‚¨ãƒ”ãƒƒã‚¯';
                            droppedItem.color = '#a855f7';
                        }
                    }
                } else if (enemyType === 'å¤§ãƒœã‚¹') {
                    // å¤§ãƒœã‚¹ï¼š70%ç¢ºç‡ã§å¼·åŠ›è£…å‚™ï¼ˆé«˜ç¢ºç‡ã§ã‚¢ãƒ•ã‚£ãƒƒã‚¯ã‚¹ä»˜ãï¼‰
                    if (Math.random() < 0.7) {
                        const dropTable = this.dropTables.boss[this.currentArea];
                        const item = dropTable[Math.floor(Math.random() * dropTable.length)];
                        droppedItem = {
                            id: Date.now() + Math.random(),
                            name: item.name,
                            type: item.type,
                            attack: item.attack,
                            defense: item.defense,
                            rarity: 'ã‚¨ãƒ”ãƒƒã‚¯',
                            color: '#a855f7',
                            affixes: []
                        };
                        
                        // 60%ã§1ã¤ã€30%ã§2ã¤ã®ã‚¢ãƒ•ã‚£ãƒƒã‚¯ã‚¹
                        const affixRoll = Math.random();
                        if (affixRoll < 0.6) {
                            const affix = this.affixes.positive[Math.floor(Math.random() * this.affixes.positive.length)];
                            droppedItem.affixes.push(affix);
                            droppedItem.name = `${affix.name}${droppedItem.name}`;
                            
                            if (affixRoll < 0.3) {
                                const affix2 = this.affixes.positive[Math.floor(Math.random() * this.affixes.positive.length)];
                                if (affix2.name !== affix.name) {
                                    droppedItem.affixes.push(affix2);
                                    droppedItem.rarity = 'ãƒ¬ã‚¸ã‚§ãƒ³ãƒ€ãƒªãƒ¼';
                                    droppedItem.color = '#f59e0b';
                                }
                            }
                        }
                    }
                    
                    // ã‚¨ãƒªã‚¢ã‚¯ãƒªã‚¢å‡¦ç†
                    if (!this.clearedAreas.includes(this.currentArea)) {
                        this.clearedAreas.push(this.currentArea);
                        this.addBattleLog(`ğŸ‰ ã‚¨ãƒªã‚¢${this.currentArea}ã‚’ã‚¯ãƒªã‚¢ï¼æ¬¡ã®ã‚¨ãƒªã‚¢ãŒè§£æ”¾ã•ã‚ŒãŸï¼`, 'level-up');
                    }
                }

                if (droppedItem) {
                    if (this.player.inventory.length >= this.player.inventoryMax) {
                        this.addBattleLog(`æ‰€æŒæ ãŒã„ã£ã±ã„ï¼${droppedItem.name}ã¯å€‰åº«ã«é€ã‚‰ã‚ŒãŸ`, 'level-up');
                        if (this.player.storage.length < this.player.storageMax) {
                            this.player.storage.push(droppedItem);
                        } else {
                            this.addBattleLog(`å€‰åº«ã‚‚ã„ã£ã±ã„ï¼${droppedItem.name}ã¯å¤±ã‚ã‚ŒãŸâ€¦`, 'damage');
                        }
                    } else {
                        this.player.inventory.push(droppedItem);
                        this.addBattleLog(`${droppedItem.name}ã‚’æ‰‹ã«å…¥ã‚ŒãŸï¼`, 'level-up');
                    }
                }

                this.updateUI();
                this.inBattle = false;
                this.enemy = null;

                setTimeout(() => {
                    this.showScreen('dungeon');
                }, 2500);
            },

            checkLevelUp() {
                let leveledUp = false;
                while (this.player.exp >= this.player.expToLevel) {
                    this.player.level++;
                    this.player.exp -= this.player.expToLevel;
                    this.player.expToLevel = Math.floor(this.player.expToLevel * 1.6);
                    this.player.skillPoints += 3;
                    this.player.maxHp += 20;
                    this.player.hp = this.player.maxHp;
                    this.player.maxSp += 5;
                    this.player.sp = this.player.maxSp;
                    leveledUp = true;
                    this.addBattleLog(`ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼Lv.${this.player.level}ã«ãªã£ãŸï¼`, 'level-up');
                    this.addBattleLog(`ã‚¹ã‚­ãƒ«ãƒã‚¤ãƒ³ãƒˆ+3ç²å¾—ï¼`, 'level-up');
                }
                if (leveledUp) {
                    alert(`ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼ç¾åœ¨ãƒ¬ãƒ™ãƒ«: ${this.player.level}`);
                }
            },

            generateRandomItem() {
                const rarities = [
                    { name: 'ã‚³ãƒ¢ãƒ³', chance: 0.50, minStat: 1.0, maxStat: 1.0, color: '#94a3b8' },
                    { name: 'ã‚¢ãƒ³ã‚³ãƒ¢ãƒ³', chance: 0.75, minStat: 1.2, maxStat: 1.4, color: '#22c55e' },
                    { name: 'ãƒ¬ã‚¢', chance: 0.90, minStat: 1.5, maxStat: 1.8, color: '#3b82f6' },
                    { name: 'ã‚¨ãƒ”ãƒƒã‚¯', chance: 0.97, minStat: 2.0, maxStat: 2.3, color: '#a855f7' },
                    { name: 'ãƒ¬ã‚¸ã‚§ãƒ³ãƒ€ãƒªãƒ¼', chance: 1.0, minStat: 2.5, maxStat: 3.0, color: '#f59e0b' }
                ];

                const roll = Math.random();
                let rarity = rarities[0];
                for (let r of rarities) {
                    if (roll < r.chance) {
                        rarity = r;
                        break;
                    }
                }

                const itemTypes = ['weapon', 'armor', 'accessory'];
                const type = itemTypes[Math.floor(Math.random() * itemTypes.length)];
                
                let template;
                if (type === 'weapon') {
                    template = this.weaponTemplates[Math.floor(Math.random() * this.weaponTemplates.length)];
                } else if (type === 'armor') {
                    template = this.armorTemplates[Math.floor(Math.random() * this.armorTemplates.length)];
                } else {
                    template = { name: 'ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼', minAtk: 2, maxAtk: 5, minDef: 2, maxDef: 5 };
                }

                const statMultiplier = rarity.minStat + Math.random() * (rarity.maxStat - rarity.minStat);
                const levelBonus = 1 + this.dungeonDepth * 0.2;

                let item = {
                    id: Date.now() + Math.random(),
                    name: template.name,
                    type: type,
                    rarity: rarity.name,
                    color: rarity.color,
                    attack: 0,
                    defense: 0,
                    affixes: []
                };

                if (type === 'weapon') {
                    const baseAtk = template.minAtk + Math.random() * (template.maxAtk - template.minAtk);
                    item.attack = Math.floor(baseAtk * statMultiplier * levelBonus);
                } else if (type === 'armor') {
                    const baseDef = template.minDef + Math.random() * (template.maxDef - template.minDef);
                    item.defense = Math.floor(baseDef * statMultiplier * levelBonus);
                } else {
                    item.attack = Math.floor((2 + Math.random() * 3) * statMultiplier * levelBonus);
                    item.defense = Math.floor((2 + Math.random() * 3) * statMultiplier * levelBonus);
                }

                // ã‚¢ãƒ•ã‚£ãƒƒã‚¯ã‚¹ä»˜ä¸ï¼ˆãƒ¬ã‚¢ä»¥ä¸Šï¼‰
                if (rarity.name === 'ãƒ¬ã‚¢' && Math.random() < 0.5) {
                    const affix = this.affixes.positive[Math.floor(Math.random() * this.affixes.positive.length)];
                    item.affixes.push(affix);
                    item.name = `${affix.name}${item.name}`;
                } else if (rarity.name === 'ã‚¨ãƒ”ãƒƒã‚¯' || rarity.name === 'ãƒ¬ã‚¸ã‚§ãƒ³ãƒ€ãƒªãƒ¼') {
                    const count = rarity.name === 'ãƒ¬ã‚¸ã‚§ãƒ³ãƒ€ãƒªãƒ¼' ? 2 : 1;
                    for (let i = 0; i < count; i++) {
                        const affix = this.affixes.positive[Math.floor(Math.random() * this.affixes.positive.length)];
                        item.affixes.push(affix);
                    }
                    item.name = `${item.affixes[0].name}${item.name}`;
                    
                    // ä½ç¢ºç‡ã§ãƒã‚¤ãƒŠã‚¹ã‚¢ãƒ•ã‚£ãƒƒã‚¯ã‚¹
                    if (Math.random() < 0.1) {
                        const negAffix = this.affixes.negative[Math.floor(Math.random() * this.affixes.negative.length)];
                        item.affixes.push(negAffix);
                    }
                }

                return item;
            },

            calculateStats() {
                let totalAttack = this.player.attack * this.player.skills.attack;
                let totalDefense = this.player.defense * this.player.skills.defense;

                ['weapon', 'armor', 'accessory'].forEach(slot => {
                    const item = this.player.equipment[slot];
                    if (!item) return;

                    totalAttack += item.attack || 0;
                    totalDefense += item.defense || 0;

                    // ã‚¢ãƒ•ã‚£ãƒƒã‚¯ã‚¹åŠ¹æœï¼ˆæ°¸ç¶šçš„ãªåŠ¹æœï¼‰
                    if (item.affixes) {
                        item.affixes.forEach(affix => {
                            if (affix.effect === 'hpBonus') {
                                this.player.maxHp = 100 + 20 * this.player.skills.hp + affix.value;
                            } else if (affix.effect === 'defBonus') {
                                totalDefense += affix.value;
                            } else if (affix.effect === 'atkBonus') {
                                totalAttack += affix.value;
                            } else if (affix.effect === 'atkPenalty') {
                                totalAttack -= affix.value;
                            } else if (affix.effect === 'damageTaken') {
                                // è¢«ãƒ€ãƒ¡ãƒ¼ã‚¸å¢—åŠ ã¯æˆ¦é—˜è¨ˆç®—æ™‚ã«é©ç”¨
                            }
                        });
                    }
                });

                return { attack: Math.max(1, totalAttack), defense: Math.max(0, totalDefense) };
            },

            flee() {
                if (!this.inBattle || !this.enemy) return;

                if (Math.random() < 0.6) {
                    this.addBattleLog('é€ƒã’å‡ºã—ãŸï¼');
                    this.inBattle = false;
                    this.enemy = null;
                    setTimeout(() => this.showScreen('dungeon'), 800);
                } else {
                    this.addBattleLog('é€ƒã’ã‚‰ã‚Œãªã‹ã£ãŸï¼');
                    this.enemyTurn();
                }
            },

            gameOver() {
                alert('ã‚ãªãŸã¯å€’ã‚ŒãŸ...\nç”ºã§å¾©æ´»ã—ã¾ã™ã€‚ï¼ˆã‚´ãƒ¼ãƒ«ãƒ‰ã®ä¸€éƒ¨ã‚’å¤±ã£ãŸï¼‰');
                this.player.hp = this.player.maxHp;
                this.player.sp = this.player.maxSp;
                this.player.gold = Math.floor(this.player.gold * 0.7);
                this.dungeonDepth = 1;
                this.inBattle = false;
                this.enemy = null;
                this.updateUI();
                this.showScreen('town');
            },

            rest() {
                const cost = 30;
                if (this.player.gold >= cost) {
                    this.player.gold -= cost;
                    this.player.hp = this.player.maxHp;
                    this.player.sp = this.player.maxSp;
                    this.updateUI();
                    alert('å®¿å±‹ã§ä¼‘ã‚“ã ã€‚HPã¨SPãŒå…¨å›å¾©ã—ãŸï¼');
                } else {
                    alert('ã‚´ãƒ¼ãƒ«ãƒ‰ãŒè¶³ã‚Šãªã„ï¼');
                }
            },

            openShop() {
                this.showScreen('shop');
            },

            buyItem(itemId) {
                const items = {
                    'small-potion': { cost: 20, name: 'å°å›å¾©è–¬' },
                    'large-potion': { cost: 50, name: 'å¤§å›å¾©è–¬' },
                    'sp-potion': { cost: 30, name: 'SPå›å¾©è–¬' },
                    'full-potion': { cost: 100, name: 'ä¸‡èƒ½è–¬' },
                    'smoke-bomb': { cost: 80, name: 'ç…™ç‰' }
                };

                const item = items[itemId];
                if (!item) return;

                if (this.player.gold < item.cost) {
                    alert('ã‚´ãƒ¼ãƒ«ãƒ‰ãŒè¶³ã‚Šãªã„ï¼');
                    return;
                }

                this.player.gold -= item.cost;
                
                if (itemId === 'small-potion') {
                    this.player.items.smallPotion++;
                } else if (itemId === 'large-potion') {
                    this.player.items.largePotion++;
                } else if (itemId === 'sp-potion') {
                    this.player.items.spPotion++;
                } else if (itemId === 'full-potion') {
                    this.player.items.fullPotion++;
                } else if (itemId === 'smoke-bomb') {
                    this.player.items.smokeBomb = (this.player.items.smokeBomb || 0) + 1;
                }

                this.updateUI();
                alert(`${item.name}ã‚’è³¼å…¥ã—ãŸï¼`);
            },

            openGacha() {
                this.showScreen('gacha');
                this.updateUI();
            },

            rollGacha() {
                const cost = 250;
                if (this.player.gold < cost) {
                    alert('ã‚´ãƒ¼ãƒ«ãƒ‰ãŒè¶³ã‚Šãªã„ï¼ï¼ˆ250Gå¿…è¦ï¼‰');
                    return;
                }

                this.player.gold -= cost;

                const roll = Math.random();
                let resultItem;
                let rarityText = '';
                let resultMessage = '';

                if (roll < 0.03) {
                    // ãƒ¦ãƒ‹ãƒ¼ã‚¯ 3%
                    const unique = this.uniqueItems[Math.floor(Math.random() * this.uniqueItems.length)];
                    resultItem = {
                        ...unique,
                        id: Date.now() + Math.random(),
                        rarity: 'ãƒ¦ãƒ‹ãƒ¼ã‚¯',
                        color: '#ef4444',
                        affixes: unique.affixes.map(name => {
                            return this.affixes.positive.find(a => a.name === name) || { name, effect: 'none', value: 0 };
                        })
                    };
                    rarityText = 'ğŸ‰ ãƒ¦ãƒ‹ãƒ¼ã‚¯ï¼ï¼ï¼';
                    
                    // ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã«è¿½åŠ 
                    if (this.player.inventory.length < this.player.inventoryMax) {
                        this.player.inventory.push(resultItem);
                    } else if (this.player.storage.length < this.player.storageMax) {
                        this.player.storage.push(resultItem);
                        resultMessage += '\nâ€»æ‰€æŒæ ãŒã„ã£ã±ã„ã®ãŸã‚å€‰åº«ã«é€ã‚‰ã‚Œã¾ã—ãŸ';
                    } else {
                        resultMessage += '\nâ€»æ‰€æŒæ ã‚‚å€‰åº«ã‚‚ã„ã£ã±ã„ã®ãŸã‚ã‚¢ã‚¤ãƒ†ãƒ ã¯å¤±ã‚ã‚Œã¾ã—ãŸ';
                    }
                    
                    const typeText = resultItem.type === 'weapon' ? 'æ­¦å™¨' : resultItem.type === 'armor' ? 'é˜²å…·' : 'ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼';
                    let affixText = '';
                    if (resultItem.affixes && resultItem.affixes.length > 0) {
                        affixText = '\n\nã€ç‰¹æ®ŠåŠ¹æœã€‘\n' + resultItem.affixes.map(a => `ãƒ»${a.description}`).join('\n');
                    }
                    this.showGachaResult(rarityText, resultItem, typeText, affixText, resultMessage);
                } else if (roll < 0.13) {
                    // ãƒ¬ã‚¸ã‚§ãƒ³ãƒ€ãƒªãƒ¼ 10%
                    const itemTypes = ['weapon', 'armor', 'accessory'];
                    const type = itemTypes[Math.floor(Math.random() * itemTypes.length)];
                    
                    let template;
                    if (type === 'weapon') {
                        template = this.weaponTemplates[Math.floor(Math.random() * this.weaponTemplates.length)];
                        const baseAtk = template.minAtk + Math.random() * (template.maxAtk - template.minAtk);
                        resultItem = {
                            id: Date.now() + Math.random(),
                            name: template.name,
                            type: 'weapon',
                            attack: Math.floor(baseAtk * 2.5),
                            defense: 0,
                            rarity: 'ãƒ¬ã‚¸ã‚§ãƒ³ãƒ€ãƒªãƒ¼',
                            color: '#f59e0b',
                            affixes: []
                        };
                    } else if (type === 'armor') {
                        template = this.armorTemplates[Math.floor(Math.random() * this.armorTemplates.length)];
                        const baseDef = template.minDef + Math.random() * (template.maxDef - template.minDef);
                        resultItem = {
                            id: Date.now() + Math.random(),
                            name: template.name,
                            type: 'armor',
                            attack: 0,
                            defense: Math.floor(baseDef * 2.5),
                            rarity: 'ãƒ¬ã‚¸ã‚§ãƒ³ãƒ€ãƒªãƒ¼',
                            color: '#f59e0b',
                            affixes: []
                        };
                    } else {
                        resultItem = {
                            id: Date.now() + Math.random(),
                            name: 'ãƒ¬ã‚¸ã‚§ãƒ³ãƒ€ãƒªãƒ¼ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼',
                            type: 'accessory',
                            attack: Math.floor((2 + Math.random() * 3) * 2.5),
                            defense: Math.floor((2 + Math.random() * 3) * 2.5),
                            rarity: 'ãƒ¬ã‚¸ã‚§ãƒ³ãƒ€ãƒªãƒ¼',
                            color: '#f59e0b',
                            affixes: []
                        };
                    }
                    rarityText = 'âœ¨ ãƒ¬ã‚¸ã‚§ãƒ³ãƒ€ãƒªãƒ¼ï¼';
                    
                    // ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã«è¿½åŠ 
                    if (this.player.inventory.length < this.player.inventoryMax) {
                        this.player.inventory.push(resultItem);
                    } else if (this.player.storage.length < this.player.storageMax) {
                        this.player.storage.push(resultItem);
                        resultMessage += '\nâ€»æ‰€æŒæ ãŒã„ã£ã±ã„ã®ãŸã‚å€‰åº«ã«é€ã‚‰ã‚Œã¾ã—ãŸ';
                    } else {
                        resultMessage += '\nâ€»æ‰€æŒæ ã‚‚å€‰åº«ã‚‚ã„ã£ã±ã„ã®ãŸã‚ã‚¢ã‚¤ãƒ†ãƒ ã¯å¤±ã‚ã‚Œã¾ã—ãŸ';
                    }
                    
                    const typeText1 = resultItem.type === 'weapon' ? 'æ­¦å™¨' : resultItem.type === 'armor' ? 'é˜²å…·' : 'ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼';
                    let affixText1 = '';
                    if (resultItem.affixes && resultItem.affixes.length > 0) {
                        affixText1 = '\n\nã€ç‰¹æ®ŠåŠ¹æœã€‘\n' + resultItem.affixes.map(a => `ãƒ»${a.description}`).join('\n');
                    }
                    this.showGachaResult(rarityText, resultItem, typeText1, affixText1, resultMessage);
                } else if (roll < 0.33) {
                    // ã‚¨ãƒ”ãƒƒã‚¯ 20%
                    resultItem = this.generateGachaItem('epic');
                    rarityText = 'ğŸŒŸ ã‚¨ãƒ”ãƒƒã‚¯ï¼';
                    
                    if (this.player.inventory.length < this.player.inventoryMax) {
                        this.player.inventory.push(resultItem);
                    } else if (this.player.storage.length < this.player.storageMax) {
                        this.player.storage.push(resultItem);
                        resultMessage += '\nâ€»æ‰€æŒæ ãŒã„ã£ã±ã„ã®ãŸã‚å€‰åº«ã«é€ã‚‰ã‚Œã¾ã—ãŸ';
                    } else {
                        resultMessage += '\nâ€»æ‰€æŒæ ã‚‚å€‰åº«ã‚‚ã„ã£ã±ã„ã®ãŸã‚ã‚¢ã‚¤ãƒ†ãƒ ã¯å¤±ã‚ã‚Œã¾ã—ãŸ';
                    }
                    
                    const typeText2 = resultItem.type === 'weapon' ? 'æ­¦å™¨' : resultItem.type === 'armor' ? 'é˜²å…·' : 'ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼';
                    let affixText2 = '';
                    if (resultItem.affixes && resultItem.affixes.length > 0) {
                        affixText2 = '\n\nã€ç‰¹æ®ŠåŠ¹æœã€‘\n' + resultItem.affixes.map(a => `ãƒ»${a.description}`).join('\n');
                    }
                    this.showGachaResult(rarityText, resultItem, typeText2, affixText2, resultMessage);
                } else if (roll < 0.63) {
                    // ãƒ¬ã‚¢ 30%
                    resultItem = this.generateGachaItem('rare');
                    rarityText = 'ğŸ’ ãƒ¬ã‚¢ï¼';
                    
                    if (this.player.inventory.length < this.player.inventoryMax) {
                        this.player.inventory.push(resultItem);
                    } else if (this.player.storage.length < this.player.storageMax) {
                        this.player.storage.push(resultItem);
                        resultMessage += '\nâ€»æ‰€æŒæ ãŒã„ã£ã±ã„ã®ãŸã‚å€‰åº«ã«é€ã‚‰ã‚Œã¾ã—ãŸ';
                    } else {
                        resultMessage += '\nâ€»æ‰€æŒæ ã‚‚å€‰åº«ã‚‚ã„ã£ã±ã„ã®ãŸã‚ã‚¢ã‚¤ãƒ†ãƒ ã¯å¤±ã‚ã‚Œã¾ã—ãŸ';
                    }
                    
                    const typeText3 = resultItem.type === 'weapon' ? 'æ­¦å™¨' : resultItem.type === 'armor' ? 'é˜²å…·' : 'ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼';
                    let affixText3 = '';
                    if (resultItem.affixes && resultItem.affixes.length > 0) {
                        affixText3 = '\n\nã€ç‰¹æ®ŠåŠ¹æœã€‘\n' + resultItem.affixes.map(a => `ãƒ»${a.description}`).join('\n');
                    }
                    this.showGachaResult(rarityText, resultItem, typeText3, affixText3, resultMessage);
                } else if (roll < 0.83) {
                    // ã‚¢ãƒ³ã‚³ãƒ¢ãƒ³ãƒ»ã‚³ãƒ¢ãƒ³è£…å‚™ 20%
                    resultItem = this.generateGachaItem(Math.random() < 0.5 ? 'uncommon' : 'common');
                    rarityText = resultItem.rarity === 'ã‚¢ãƒ³ã‚³ãƒ¢ãƒ³' ? 'ğŸŒ¿ ã‚¢ãƒ³ã‚³ãƒ¢ãƒ³' : 'âšª ã‚³ãƒ¢ãƒ³';
                    
                    if (this.player.inventory.length < this.player.inventoryMax) {
                        this.player.inventory.push(resultItem);
                    } else if (this.player.storage.length < this.player.storageMax) {
                        this.player.storage.push(resultItem);
                        resultMessage += '\nâ€»æ‰€æŒæ ãŒã„ã£ã±ã„ã®ãŸã‚å€‰åº«ã«é€ã‚‰ã‚Œã¾ã—ãŸ';
                    } else {
                        resultMessage += '\nâ€»æ‰€æŒæ ã‚‚å€‰åº«ã‚‚ã„ã£ã±ã„ã®ãŸã‚ã‚¢ã‚¤ãƒ†ãƒ ã¯å¤±ã‚ã‚Œã¾ã—ãŸ';
                    }
                    
                    const typeText4 = resultItem.type === 'weapon' ? 'æ­¦å™¨' : resultItem.type === 'armor' ? 'é˜²å…·' : 'ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼';
                    let affixText4 = '';
                    if (resultItem.affixes && resultItem.affixes.length > 0) {
                        affixText4 = '\n\nã€ç‰¹æ®ŠåŠ¹æœã€‘\n' + resultItem.affixes.map(a => `ãƒ»${a.description}`).join('\n');
                    }
                    this.showGachaResult(rarityText, resultItem, typeText4, affixText4, resultMessage);
                } else {
                    // ãƒã‚ºãƒ¬ï¼ˆæ¶ˆè€—å“ï¼‰ 17%
                    const itemRoll = Math.random();
                    let itemName = '';
                    if (itemRoll < 0.4) {
                        this.player.items.smallPotion += 3;
                        itemName = 'å°å›å¾©è–¬Ã—3';
                    } else if (itemRoll < 0.7) {
                        this.player.items.spPotion += 2;
                        itemName = 'SPå›å¾©è–¬Ã—2';
                    } else if (itemRoll < 0.9) {
                        this.player.items.largePotion += 1;
                        itemName = 'å¤§å›å¾©è–¬Ã—1';
                    } else {
                        this.player.items.smokeBomb = (this.player.items.smokeBomb || 0) + 1;
                        itemName = 'ç…™ç‰Ã—1 (æˆ¦é—˜ã‹ã‚‰ç¢ºå®šé€ƒèµ°)';
                    }
                    
                    const resultDiv = document.getElementById('gacha-result');
                    const contentDiv = document.getElementById('gacha-result-content');
                    contentDiv.innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 48px; margin-bottom: 15px;">ğŸ“¦</div>
                            <div style="font-size: 20px; color: var(--color-text-secondary); margin-bottom: 10px;">ãƒã‚ºãƒ¬...</div>
                            <div style="font-size: 18px; color: var(--color-text-primary);">${itemName}ã‚’ç²å¾—ï¼</div>
                        </div>
                    `;
                    resultDiv.style.display = 'block';
                }

                this.updateUI();
            },

            showGachaResult(rarityText, item, typeText, affixText, resultMessage) {
                const resultDiv = document.getElementById('gacha-result');
                const contentDiv = document.getElementById('gacha-result-content');
                
                const rarityEmoji = {
                    'ğŸ‰ ãƒ¦ãƒ‹ãƒ¼ã‚¯ï¼ï¼ï¼': 'âœ¨',
                    'âœ¨ ãƒ¬ã‚¸ã‚§ãƒ³ãƒ€ãƒªãƒ¼ï¼': 'ğŸ‘‘',
                    'ğŸŒŸ ã‚¨ãƒ”ãƒƒã‚¯ï¼': 'â­',
                    'ğŸ’ ãƒ¬ã‚¢ï¼': 'ğŸ’',
                    'ğŸŒ¿ ã‚¢ãƒ³ã‚³ãƒ¢ãƒ³': 'ğŸŒ¿',
                    'âšª ã‚³ãƒ¢ãƒ³': 'âšª'
                };
                
                const emoji = rarityEmoji[rarityText] || 'ğŸ';
                
                contentDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 64px; margin-bottom: 15px;">${emoji}</div>
                        <div style="font-size: 24px; color: ${item.color}; font-weight: 700; margin-bottom: 15px;">${rarityText}</div>
                        <div style="background: var(--color-bg-base); padding: 20px; border-radius: 8px; text-align: left;">
                            <div style="font-size: 20px; color: ${item.color}; font-weight: 600; margin-bottom: 10px;">${item.name}</div>
                            <div style="color: var(--color-text-secondary); margin-bottom: 5px;">ç¨®é¡: ${typeText}</div>
                            <div style="color: var(--color-danger); margin-bottom: 5px;">æ”»æ’ƒåŠ›: +${item.attack}</div>
                            <div style="color: var(--color-primary); margin-bottom: 10px;">é˜²å¾¡åŠ›: +${item.defense}</div>
                            ${affixText ? `<div style="color: var(--color-success); font-size: 14px; line-height: 1.6;">${affixText.replace(/\n/g, '<br>')}</div>` : ''}
                            ${resultMessage ? `<div style="color: var(--color-warning); margin-top: 10px; font-size: 14px;">${resultMessage}</div>` : ''}
                        </div>
                    </div>
                `;
                
                resultDiv.style.display = 'block';
            },

            generateGachaItem(rarity) {
                const rarityMap = {
                    'common': { name: 'ã‚³ãƒ¢ãƒ³', color: '#94a3b8', multiplier: 1.0 },
                    'uncommon': { name: 'ã‚¢ãƒ³ã‚³ãƒ¢ãƒ³', color: '#22c55e', multiplier: 1.3 },
                    'rare': { name: 'ãƒ¬ã‚¢', color: '#3b82f6', multiplier: 1.7 },
                    'epic': { name: 'ã‚¨ãƒ”ãƒƒã‚¯', color: '#a855f7', multiplier: 2.2 }
                };

                const rarityInfo = rarityMap[rarity];
                const itemTypes = ['weapon', 'armor', 'accessory'];
                const type = itemTypes[Math.floor(Math.random() * itemTypes.length)];
                
                let item;
                if (type === 'weapon') {
                    const template = this.weaponTemplates[Math.floor(Math.random() * this.weaponTemplates.length)];
                    const baseAtk = template.minAtk + Math.random() * (template.maxAtk - template.minAtk);
                    item = {
                        id: Date.now() + Math.random(),
                        name: template.name,
                        type: 'weapon',
                        attack: Math.floor(baseAtk * rarityInfo.multiplier),
                        defense: 0,
                        rarity: rarityInfo.name,
                        color: rarityInfo.color,
                        affixes: []
                    };
                } else if (type === 'armor') {
                    const template = this.armorTemplates[Math.floor(Math.random() * this.armorTemplates.length)];
                    const baseDef = template.minDef + Math.random() * (template.maxDef - template.minDef);
                    item = {
                        id: Date.now() + Math.random(),
                        name: template.name,
                        type: 'armor',
                        attack: 0,
                        defense: Math.floor(baseDef * rarityInfo.multiplier),
                        rarity: rarityInfo.name,
                        color: rarityInfo.color,
                        affixes: []
                    };
                } else {
                    item = {
                        id: Date.now() + Math.random(),
                        name: `${rarityInfo.name}ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼`,
                        type: 'accessory',
                        attack: Math.floor((2 + Math.random() * 3) * rarityInfo.multiplier),
                        defense: Math.floor((2 + Math.random() * 3) * rarityInfo.multiplier),
                        rarity: rarityInfo.name,
                        color: rarityInfo.color,
                        affixes: []
                    };
                }

                return item;
            },

            showInventory() {
                this.showScreen('inventory');
                this.renderInventory();
            },

            renderInventory() {
                const container = document.getElementById('inventory-list');
                container.innerHTML = '';

                // è£…å‚™ä¸­ã®ã‚¢ã‚¤ãƒ†ãƒ è¡¨ç¤º
                const equippedDiv = document.createElement('div');
                equippedDiv.innerHTML = '<h3 style="color: var(--color-primary); margin-bottom: 15px;">è£…å‚™ä¸­</h3>';
                
                ['weapon', 'armor', 'accessory'].forEach(slot => {
                    const item = this.player.equipment[slot];
                    const slotName = { weapon: 'æ­¦å™¨', armor: 'é˜²å…·', accessory: 'ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼' }[slot];
                    
                    const slotDiv = document.createElement('div');
                    slotDiv.className = 'inventory-item';
                    
                    let affixText = '';
                    if (item && item.affixes && item.affixes.length > 0) {
                        affixText = '<br><span class="affix-positive">' + 
                            item.affixes.map(a => `${a.name} (${a.description})`).join('<br>') + '</span>';
                    }
                    
                    slotDiv.innerHTML = `
                        <strong>${slotName}:</strong> ${item ? 
                            `<span style="color: ${item.color}">${item.name}</span> (æ”»+${item.attack} é˜²+${item.defense})${affixText}` : 
                            'æœªè£…å‚™'}
                        ${item ? '<button onclick="game.unequipItem(\'' + slot + '\')" style="margin-left: 10px; padding: 5px 10px;">å¤–ã™</button>' : ''}
                    `;
                    equippedDiv.appendChild(slotDiv);
                });
                container.appendChild(equippedDiv);

                // ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã®ã‚¢ã‚¤ãƒ†ãƒ è¡¨ç¤º
                if (this.player.inventory.length > 0) {
                    const inventoryDiv = document.createElement('div');
                    inventoryDiv.innerHTML = '<h3 style="color: var(--color-primary); margin: 20px 0 15px;">æ‰€æŒã‚¢ã‚¤ãƒ†ãƒ </h3>';
                    
                    this.player.inventory.forEach((item, index) => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'inventory-item';
                        
                        let affixText = '';
                        if (item.affixes && item.affixes.length > 0) {
                            affixText = '<br><span class="affix-positive">' + 
                                item.affixes.map(a => `${a.name} (${a.description})`).join('<br>') + '</span>';
                        }
                        
                        itemDiv.innerHTML = `
                            <div style="margin-bottom: 8px;">
                                <span style="color: ${item.color}; font-weight: 600;">${item.name}</span>
                                <span style="color: var(--color-text-secondary);">(æ”»+${item.attack} é˜²+${item.defense})</span>${affixText}
                            </div>
                            <div>
                                <button onclick="game.equipItem(${index})" style="padding: 5px 10px;">è£…å‚™</button>
                                <button onclick="game.moveToStorage(${index})" style="margin-left: 5px; padding: 5px 10px;">å€‰åº«ã¸</button>
                            </div>
                        `;
                        inventoryDiv.appendChild(itemDiv);
                    });
                    container.appendChild(inventoryDiv);
                } else {
                    const emptyDiv = document.createElement('div');
                    emptyDiv.innerHTML = '<p style="color: var(--color-text-muted); margin-top: 20px;">ã‚¢ã‚¤ãƒ†ãƒ ã‚’æŒã£ã¦ã„ã¾ã›ã‚“</p>';
                    container.appendChild(emptyDiv);
                }
            },

            showStorage() {
                this.showScreen('storage');
                this.renderStorage();
            },

            renderStorage() {
                const container = document.getElementById('storage-list');
                container.innerHTML = '';
                
                document.getElementById('storage-usage').textContent = `${this.player.storage.length}/${this.player.storageMax}`;
                
                const expandCost = 500 * Math.pow(2, Math.floor(this.player.storageMax / 10) - 1);
                document.getElementById('expand-cost').textContent = expandCost;

                if (this.player.storage.length > 0) {
                    const storageDiv = document.createElement('div');
                    storageDiv.innerHTML = '<h3 style="color: var(--color-primary); margin-bottom: 15px;">å€‰åº«å†…ã‚¢ã‚¤ãƒ†ãƒ </h3>';
                    
                    this.player.storage.forEach((item, index) => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'inventory-item';
                        
                        let affixText = '';
                        if (item.affixes && item.affixes.length > 0) {
                            affixText = '<br><span class="affix-positive">' + 
                                item.affixes.map(a => `${a.name} (${a.description})`).join('<br>') + '</span>';
                        }
                        
                        itemDiv.innerHTML = `
                            <div style="margin-bottom: 8px;">
                                <span style="color: ${item.color}; font-weight: 600;">${item.name}</span>
                                <span style="color: var(--color-text-secondary);">(æ”»+${item.attack} é˜²+${item.defense})</span>${affixText}
                            </div>
                            <div>
                                <button onclick="game.retrieveFromStorage(${index})" style="padding: 5px 10px;">å–ã‚Šå‡ºã™</button>
                            </div>
                        `;
                        storageDiv.appendChild(itemDiv);
                    });
                    container.appendChild(storageDiv);
                } else {
                    const emptyDiv = document.createElement('div');
                    emptyDiv.innerHTML = '<p style="color: var(--color-text-muted);">å€‰åº«ã¯ç©ºã§ã™</p>';
                    container.appendChild(emptyDiv);
                }
            },

            moveToStorage(index) {
                if (this.player.storage.length >= this.player.storageMax) {
                    alert('å€‰åº«ãŒã„ã£ã±ã„ã§ã™ï¼æ‹¡å¼µã™ã‚‹ã‹ã€ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ•´ç†ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                
                const item = this.player.inventory[index];
                if (!item) {
                    alert('ã‚¢ã‚¤ãƒ†ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }
                this.player.storage.push(item);
                this.player.inventory.splice(index, 1);
                this.renderInventory();
                this.updateUI();
                alert(`${item.name}ã‚’å€‰åº«ã«é ã‘ã¾ã—ãŸã€‚`);
            },

            retrieveFromStorage(index) {
                if (this.player.inventory.length >= this.player.inventoryMax) {
                    alert('æ‰€æŒæ ãŒã„ã£ã±ã„ã§ã™ï¼ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ•´ç†ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                
                const item = this.player.storage[index];
                if (!item) {
                    alert('ã‚¢ã‚¤ãƒ†ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }
                this.player.inventory.push(item);
                this.player.storage.splice(index, 1);
                this.renderStorage();
                this.updateUI();
                alert(`${item.name}ã‚’å€‰åº«ã‹ã‚‰å–ã‚Šå‡ºã—ã¾ã—ãŸã€‚`);
            },

            expandStorage() {
                const expandCost = 500 * Math.pow(2, Math.floor(this.player.storageMax / 10) - 1);
                
                if (this.player.gold < expandCost) {
                    alert('ã‚´ãƒ¼ãƒ«ãƒ‰ãŒè¶³ã‚Šã¾ã›ã‚“ï¼');
                    return;
                }
                
                if (confirm(`${expandCost}Gã§å€‰åº«ã‚’10æ æ‹¡å¼µã—ã¾ã™ã‹ï¼Ÿ`)) {
                    this.player.gold -= expandCost;
                    this.player.storageMax += 10;
                    this.renderStorage();
                    this.updateUI();
                    alert('å€‰åº«ã‚’æ‹¡å¼µã—ã¾ã—ãŸï¼');
                }
            },

            showShopSellInventory() {
                this.shopSellMode = 'inventory';
                this.renderShopSell();
            },

            showShopSellStorage() {
                this.shopSellMode = 'storage';
                this.renderShopSell();
            },

            renderShopSell() {
                const container = document.getElementById('shop-sell-list');
                container.innerHTML = '';

                if (this.shopSellMode === 'inventory') {
                    if (this.player.inventory.length === 0) {
                        container.innerHTML = '<p style="color: var(--color-text-muted); text-align: center;">ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã«ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                        return;
                    }

                    container.innerHTML = '<h4 style="color: var(--color-primary); margin-bottom: 10px;">ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒª</h4>';
                    
                    this.player.inventory.forEach((item, index) => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'inventory-item';
                        itemDiv.style.marginBottom = '10px';
                        
                        let affixText = '';
                        if (item.affixes && item.affixes.length > 0) {
                            affixText = '<br><span class="affix-positive">' + 
                                item.affixes.map(a => `${a.name} (${a.description})`).join('<br>') + '</span>';
                        }
                        
                        let baseSellPrice = Math.floor((item.attack + item.defense) * 8);
                        if (item.affixes && item.affixes.length > 0) {
                            baseSellPrice += item.affixes.length * 50;
                        }
                        const sellPrice = Math.max(10, baseSellPrice);
                        
                        itemDiv.innerHTML = `
                            <div style="margin-bottom: 8px;">
                                <span style="color: ${item.color}; font-weight: 600;">${item.name}</span>
                                <span style="color: var(--color-text-secondary);">(æ”»+${item.attack} é˜²+${item.defense})</span>${affixText}
                            </div>
                            <button onclick="game.sellFromInventory(${index})" style="padding: 5px 15px; background: var(--color-warning);">ğŸ’° ${sellPrice}Gã§å£²å´</button>
                        `;
                        container.appendChild(itemDiv);
                    });
                } else if (this.shopSellMode === 'storage') {
                    if (this.player.storage.length === 0) {
                        container.innerHTML = '<p style="color: var(--color-text-muted); text-align: center;">å€‰åº«ã«ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                        return;
                    }

                    container.innerHTML = '<h4 style="color: var(--color-primary); margin-bottom: 10px;">å€‰åº«</h4>';
                    
                    this.player.storage.forEach((item, index) => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'inventory-item';
                        itemDiv.style.marginBottom = '10px';
                        
                        let affixText = '';
                        if (item.affixes && item.affixes.length > 0) {
                            affixText = '<br><span class="affix-positive">' + 
                                item.affixes.map(a => `${a.name} (${a.description})`).join('<br>') + '</span>';
                        }
                        
                        let baseSellPrice2 = Math.floor((item.attack + item.defense) * 8);
                        if (item.affixes && item.affixes.length > 0) {
                            baseSellPrice2 += item.affixes.length * 50;
                        }
                        const sellPrice2 = Math.max(10, baseSellPrice2);
                        
                        itemDiv.innerHTML = `
                            <div style="margin-bottom: 8px;">
                                <span style="color: ${item.color}; font-weight: 600;">${item.name}</span>
                                <span style="color: var(--color-text-secondary);">(æ”»+${item.attack} é˜²+${item.defense})</span>${affixText}
                            </div>
                            <button onclick="game.sellFromStorage(${index})" style="padding: 5px 15px; background: var(--color-warning);">ğŸ’° ${sellPrice2}Gã§å£²å´</button>
                        `;
                        container.appendChild(itemDiv);
                    });
                }
            },

            sellFromInventory(index) {
                const item = this.player.inventory[index];
                if (!item) return;
                
                let baseSellPrice = Math.floor((item.attack + item.defense) * 8);
                if (item.affixes && item.affixes.length > 0) {
                    baseSellPrice += item.affixes.length * 50;
                }
                const sellPrice = Math.max(10, baseSellPrice);
                
                this.player.gold += sellPrice;
                this.player.inventory.splice(index, 1);
                alert(`${item.name}ã‚’${sellPrice}Gã§å£²å´ã—ã¾ã—ãŸï¼`);
                this.renderShopSell();
                this.updateUI();
            },

            sellFromStorage(index) {
                const item = this.player.storage[index];
                if (!item) return;
                
                let baseSellPrice = Math.floor((item.attack + item.defense) * 8);
                if (item.affixes && item.affixes.length > 0) {
                    baseSellPrice += item.affixes.length * 50;
                }
                const sellPrice = Math.max(10, baseSellPrice);
                
                this.player.gold += sellPrice;
                this.player.storage.splice(index, 1);
                alert(`${item.name}ã‚’${sellPrice}Gã§å£²å´ã—ã¾ã—ãŸï¼`);
                this.renderShopSell();
                this.updateUI();
            },

            equipItem(index) {
                const item = this.player.inventory[index];
                if (!item) {
                    alert('ã‚¢ã‚¤ãƒ†ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }
                const slot = item.type;

                if (this.player.equipment[slot]) {
                    if (this.player.inventory.length >= this.player.inventoryMax) {
                        alert('æ‰€æŒæ ãŒã„ã£ã±ã„ã§ã™ï¼å…ˆã«è£…å‚™ã‚’å¤–ã—ã¦ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç©ºã‘ã¦ãã ã•ã„ã€‚');
                        return;
                    }
                    this.player.inventory.push(this.player.equipment[slot]);
                }

                this.player.equipment[slot] = item;
                this.player.inventory.splice(index, 1);
                this.renderInventory();
                this.updateUI();
            },

            unequipItem(slot) {
                const item = this.player.equipment[slot];
                if (!item) return;
                
                if (this.player.inventory.length >= this.player.inventoryMax) {
                    alert('æ‰€æŒæ ãŒã„ã£ã±ã„ã§ã™ï¼ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ•´ç†ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                
                this.player.inventory.push(item);
                this.player.equipment[slot] = null;
                this.renderInventory();
                this.updateUI();
            },

            showSkills() {
                this.showScreen('skills');
            },

            levelUpSkill(skillName) {
                if (this.player.skillPoints <= 0) {
                    alert('ã‚¹ã‚­ãƒ«ãƒã‚¤ãƒ³ãƒˆãŒè¶³ã‚Šãªã„ï¼');
                    return;
                }

                this.player.skillPoints--;

                switch(skillName) {
                    case 'attack':
                        this.player.skills.attack++;
                        break;
                    case 'defense':
                        this.player.skills.defense++;
                        break;
                    case 'hp':
                        this.player.skills.hp++;
                        this.player.maxHp += 20;
                        this.player.hp += 20;
                        break;
                    case 'power-strike':
                        this.player.skills.powerStrike++;
                        break;
                    case 'heal':
                        this.player.skills.heal++;
                        break;
                }

                this.updateUI();
                alert('ã‚¹ã‚­ãƒ«ã‚’å¼·åŒ–ã—ãŸï¼');
            },

            returnToTown() {
                this.showScreen('town');
            }
        };

        window.onload = () => game.init();
    </script>
</body>
</html>
